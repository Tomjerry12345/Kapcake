<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Kapcake POS</title>
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="css/sb-admin-2.css" rel="stylesheet">
  <link href="css/custom.css" rel="stylesheet">
  <link href="css/bootoast.css" rel="stylesheet" type="text/css">
  <link href="css/jtoggler.css" rel="stylesheet" type="text/css">
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="js/sb-admin-2.js"></script>
  <script src="js/jtoggler.js"></script>
  <style type="text/css">
    .dropbtn {
      background-color: #4CAF50;
      color: white;
      padding: 16px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    .text-muted{
      color: #6b6f82 !important;
      padding-left:10px;
    }
    .min-width-150{
      min-width: 150px;
    }
    .card-img-top h3,.card-img-top h5{
      text-align:center;
      position:relative;
      top:50%;
      transform:translateY(-50%);
    }
    .bg-grey-low{
      background: #e4e4e4; 
    }
    .bg-grey-2{
      background: #f1f1f1;
    }
    .bg-grey-1{
      background: #fafafa;
    }
    .status-sukses{
      color:#36c28f ;
    }
    .status-batal{
      color:#ff897e;
    }
    .md-button {
      overflow: hidden;
      transform: translate3d(0, 0, 0);
      display: inline-block;
      position: relative;
      cursor: pointer;
      vertical-align: middle;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      -webkit-transition: box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      transition: box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .md-button:focus {
      outline: none;
    }
    .md-button:hover,
    .md-button:focus {
      text-decoration: none;
    }
    .md-button:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #555 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    .md-button:active:after {
      transform: scale(0, 0);
      opacity: .2;
      transition: 0s;
    }

    #jumlahTunaiPembayaran::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
      color: #c4c4c4;
      opacity: 1; /* Firefox */
      text-align:left;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.3;
    }
    #jumlahTunaiPembayaran{
      text-align:right;
      font-size: 20px;
      color:#000;
      font-weight: 900;
      padding:1.6rem 1rem !important;
    }
    #btnBayarPembayaran{
      padding-top: 10px !important;
      padding-bottom: 10px !important;
      font-size: 16px;
      font-weight: 800;
    }
    .bg-cyan{
      background-color: #40b9b7 !important;
    }

    .list-group-pembayaran-padding{
      padding:10px 1.25rem !important;
    }
    #clearButtonNominalPembayaran{
      color: red;
    }

    .meja{
      border: 1px solid #e4e4e4;
      border-radius: 20px !important;
      background: #f9b88c  !important;
    }
    .meja h3{
      padding: .8rem;
      position: absolute;
    }
    .meja-aktif{
      background-color: #f9b78a;
    }
    
    .cross-button:hover{
      color:red;
    }

    .badge-pesanan{
      padding: 5px 7px;; 
      background:#f7d8c3; 
      border-radius: 5px;
    }
    .btn-printer{
      font-size: 13px;
      line-height:  1.7;
      padding: 7px 15px !important;
      border-radius: 12px !important;
    }

    .nav-link.active{
      background: #ae5d26 !important;
    }

    .modal{
      padding-left: 0 !important;
    }
    body{
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
  </style>
</head>

<body id="page-top">
  <div id="sidebarToggleOpacity" class="position-abs h-100 w-100 t-0 l-0" style=" display: none;  background: rgba(0, 0, 0, 0.48); z-index: 1000; "></div>
  <div id="wrapper">
    <ul class="navbar-nav bg-warning sidebar sidebar-dark accordion toggled fixed-top" style="box-shadow: 7px 0 5px -4px #ccc;">
      <div class="sidebar-brand d-flex align-items-center" href="index.html">
        <div class="sidebar-brand-icon ro">
          <div class="align-items-center" id="sidebarToggle">
            <i class="fas fa-fw fa-bars"></i>
          </div>
        </div>
        <div class="sidebar-brand-text mx-3">Kapcake</div>
      </div>
      <hr class="sidebar-divider my-0">
      <div>
        <li class="nav-item">
          <a class="nav-link md-button" href="#" onclick="page('kasir')">
            <i class="fas fa-fw fa-receipt"></i>
            <span>Kasir</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link md-button" href="#"  onclick="page('pesanan')">
            <i class="fas fa-fw fa-cart-arrow-down"></i>
            <span>Pesanan</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link md-button" href="#" onclick="page('riwayat')">
            <i class="fas fa-fw fa-history"></i>
            <span>Riwayat</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link md-button" href="#" onclick="page('pengaturan')">
            <i class="fas fa-fw fa-cog"></i>
            <span>Pengaturan</span>
          </a>
        </li>
        <div class="position-abs b-0">
          <li class="nav-item">
            <a class="nav-link md-button" href="#" onclick="logoutToPIN()">
              <i class="fas fa-fw fa-power-off"></i>
              <span>Keluar</span>
            </a>
          </li>
        </div>
      </div>
    </ul>
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="kasir" style="display: block;">
        <div class="px-2 pt-2 pb-0 navbar navbar-expand navbar-light topbar" style="position: fixed; left: 4.5rem; width: calc(65% - 4.5rem); background: #fff; ">
          <div class="input-group rounded-lg" style="background: #f1f1f1">
                <div class="input-group-prepend border-0" style="background: transparent;">
                  <span class="input-group-text border-0"  id="basic-addon1"  style="background: transparent;"><i class="fa fa-search"></i></span>
                </div>
                <input type="text" class="form-control border-0" placeholder="Pencarian menu..." id="pencarianMenu"  style="background: transparent;">
                <div class="input-group-append border-0" style="background: transparent;">
                    <span class="input-group-text border-0 cross-button" id="pencarianMenuCrossButton" style="background: transparent;padding: 10px 1.2rem;"><i class="fa fa-times"></i></span>
                  </div>
              </div>
        </div>
        <div class="container-fluid" style="position: fixed; left: 4.5rem; top: 3.5rem; height: calc(100vH - 3.5rem); width: calc(65% - 4.5rem);">
          <div style="position: fixed; left:inherit; top:3.5rem; background: #fafafa; height: calc(100vh - 3rem); width: inherit;">
            <div  style=" position: fixed;  left:inherit; top:3.5rem; background: #fff; height: 3.5rem; width: inherit; vertical-align: middle;z-index: 2;border-bottom: 2px solid #eee;"  class="p-2">
              
              <ul class="mui-tabs__bar hide-scroll m-0 " id="listKategoriMenu" style="margin-bottom: 0 !important;">
                <li class="mui--is-active"><a>Semua</a></li>
              </ul>
            </div>

            <div id="main-list" style=" position: fixed;  left:inherit; top:7rem; background: transparent; height: calc(100vH - 7rem); width: inherit; overflow-y: auto" class="p-2 hide-scroll">
              <div class="row" style="margin-right: 0; margin-left: 0;" id="listMenu">

              </div>
            </div>
          </div>
        </div>
        <div style="position: fixed; right:0; top:0;  background: #fff; height: 100vh; width: 35%;">
          <div class="navbar navbar-expand navbar-light topbar border-left" style=" position: fixed; right: 0; background: #fff; z-index: 51; width: inherit;">
            <h6 class="m-0 pt-2 text-dark" id="kode_pemesanan">Pesanan </h6>
            <div class="dropdown no-arrow" style="position: absolute;right: 1.3rem">
              <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-h fa-fw text-dark"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in bill-option-right" aria-labelledby="dropdownMenuLink">
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalpilihdiskon">Diskon</a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalpilihbiayatambahan">Biaya Tambahan</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" id="opsipilihhapuspesanan">Hapus Pesanan</a>
              </div>
            </div>
          </div>
          <div style="position: fixed; right: 0; top:3.5rem; ; height: calc(100vh - 3rem); width: inherit;">
            <!-- BILL CUSTOMER INFORMATION  -->
            <div  style=" position: fixed; right:inherit; top:3.5rem; background: transparent; height: 3.5rem; width: inherit; vertical-align: middle;border-bottom: 2px solid #eee;"  class="p-2 border-left">
              <div class="d-flex">
                <div class="px-3 py-2 w-50 mr-1 rounded-lg text-truncate text-center" id="btnModalPelanggan" style="color:#6e707e; background: #f1f1f1;" > 
                  <i class="fa fa-user pr-2"></i> <span id="namaPelanggan">Pelanggan</span>
                </div>
                <div class="px-3 py-2 w-50 rounded-lg text-truncate text-center" style="color:#6e707e; background: #f1f1f1;" id="btnmodalpilihmeja" data-toggle="modal" data-target="#modalpilihmeja"> 
                  <i class="fa fa-utensils pr-2"></i> <span id="namaMeja">Tanpa Meja</span>
                </div>
              </div>
            </div>

            <!-- BILL MENU LIST  -->
            <div style=" position: fixed; right:inherit; top:7rem; bottom:8rem; background: transparent; height: calc(100vH - 17.78rem); width: inherit; overflow-y: auto" class="hide-scroll  border-left">
              <ul class="list-group list-group-flush" id="list-pesanan">

              </ul>
            </div>
            <!-- BILL SUBTOTAL  -->
            <div class="border-left p-2"  style="position: fixed; right:inherit; bottom:0; background: #fff;  height: auto; width: inherit; border-top: 2px solid #eee;" >
              <div class="d-flex align-items-stretch flex-row" id="pesananSubtotal">
                <div class="px-2 py-1 flex-grow-1">
                  <div class="font-weight-bold text-sm">Subtotal</div>
                </div>
                <div class="px-2 py-1">
                  <div class="font-weight-bold text-sm"><span id="pesananSubtotalText">0</span></div>
                </div>
              </div>
              <div class="d-flex align-items-stretch flex-row" id="pesananDiskon">
                <div class="px-2 py-1 flex-grow-1">
                  <span id="pesananDiskonLabel">Diskon </span>
                </div>
                <div class="px-2 py-1"><span id="pesananDiskonText">0</span></div>
              </div>

              <div class="d-flex align-items-stretch flex-row" id="pesananBiayaTambahan">
                <div class="px-2 py-1 flex-grow-1">
                  <span id="pesananBiayaTambahanLabel">Biaya Tambahan</span>
                </div>
                <div class="px-2 py-1"><span id="pesananBiayaTambahanText">0</span></div>
              </div>

              <div class="d-flex align-items-stretch flex-row" id="pesananPajak">
                <div class="px-2 py-1 flex-grow-1">
                  <span id="pesananPajakLabel">Pajak</span>
                </div>
                <div class="px-2 py-1"><span id="pesananPajakText">0</span></div>
              </div>

              <div class="d-flex align-items-stretch flex-row mt-2">
                <div class="p-1" style="width: 25%">
                  <button class="btn btn-outline-warning btn-block " style="height: 100%" id="btnSimpanPesanan"><i class="fa fa-save"></i></button>
                </div>
                <div class="p-1 flex-fill">
                  <button class="btn btn-info btn-block text-left" id="btnBayarPesanan">
                    <div class="d-flex align-items-stretch flex-row">
                      <div class="p-1 flex-fill text-left">
                        <div class="text-truncate text-sm" >Bayar</div>
                      </div>
                      <div class="p-1 flex-fill text-right">
                        Rp&nbsp;<span class="font-weight-bold" id="pesananTotalBayarText">0</span>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- END KASIR -->

      <div id="pesanan" style="display: none">
        <div class="position-fixed t-0 " style="left:4.5rem; background: #fff; height: 100vh; width: 35%;" >
          <div class="position-fixed t-0 " style="left: inherit;  height: calc(100vh - 4rem); width: inherit;">
            <!-- LIST ORDER  -->
            <div class="p-3 border-left position-fixed t-0" style="left:inherit; background: transparent; height: 4rem; width: inherit; vertical-align: middle; border-bottom: 1px solid #eee; ">
              <p class="font-weight-bold" style="position: relative; top: 50%; transform: translateY(-50%);">Pesanan</p>
            </div>
            <!-- LIST ORDER  -->
            <div class="px-2 py-1 border-left position-fixed" style="left:inherit; top:4rem; background: #fff; height: 3rem; width: inherit; vertical-align: middle; border-bottom: 2px solid #eee; ">
              <div class="input-group rounded-lg" style="background: #fff;">
                <div class="input-group-prepend border-0" style="background: transparent;">
                  <span class="input-group-text border-0" style="background: transparent;"><i class="fa fa-search"></i></span>
                </div>
                <input type="text" class="form-control border-0" placeholder="Ketik no pemesanan atau no faktur" id="pencarianPesananTersimpan"  style="background: transparent;">
              </div>
            </div>

            <!-- ORDR LIST  -->
            <div style=" left:inherit; top:7rem;  background: transparent; height: calc(100vH - 7rem); width: inherit; overflow-y: auto" class="p-0 position-fixed hide-scroll  border-left">
              <ul class="list-group list-group-flush" id="list-pesanan-tersimpan">
                <!-- isi riwayat pesanan -->
              </ul>
            </div>
          </div>
        </div>
       
        <!-- Begin Page Content -->
        <div class="container-fluid position-fixed r-0 t-0 vh100" style="width: calc(65% - 4.5rem);width: calc(65% - 4.5rem); background: #fff; border-left: 1px solid #e4e4e4;" >
          <div class="p-3 position-fixed t-0 bg-white" style="right:inherit; height: 4rem; width: inherit; z-index: 2;border-bottom: 1px solid #e4e4e4; border-left: 1px solid #e4e4e4;">
            <p class="font-weight-bold" id="title-page-pesanan-tersimpan" style="position: relative; top: 50%; transform: translateY(-50%);"></p>
          </div>
          <div style=" position: fixed;  right:inherit; top:4rem; background: #fff; height: calc(100vH - 7.5rem); width: inherit; overflow-y: scroll;" class="hide-scroll border-left" id="detail-page-pesanan-tersimpan">
            <!-- isi detail pesanan tersimpan -->
          </div>
        </div>
      </div>

      <div id="riwayat" style="display: none">
        <div class="position-fixed t-0 " style="left:4.5rem; background: #fff; height: 100vh; width: 35%;" >
          <div class="position-fixed t-0 " style="left: inherit;  height: calc(100vh - 4rem); width: inherit;">
            <!-- LIST ORDER  -->
            <div class="p-3 border-left position-fixed t-0" style="left:inherit; background: transparent; height: 4rem; width: inherit; vertical-align: middle; border-bottom: 1px solid #eee; ">
              <p class="font-weight-bold" style="position: relative; top: 50%; transform: translateY(-50%);">Riwayat</p>
            </div>

            <!-- LIST ORDER  -->
            <div class="px-2 py-1 border-left position-fixed" style="left:inherit; top:4rem; background: #fff; height: 3rem; width: inherit; vertical-align: middle; border-bottom: 2px solid #eee; ">
              <div class="input-group rounded-lg" style="background: #fff;">
                <div class="input-group-prepend border-0" style="background: transparent;">
                  <span class="input-group-text border-0" style="background: transparent;"><i class="fa fa-search"></i></span>
                </div>
                <input type="text" class="form-control border-0" placeholder="Ketik no pemesanan atau no faktur" id="pencarianRiwayat"  style="background: transparent;">
              </div>
            </div>

            <!-- ORDR LIST  -->
            <div style=" left:inherit; top:7rem;  background: transparent; height: calc(100vH - 7rem); width: inherit; overflow-y: auto" class="p-0 position-fixed hide-scroll  border-left" id="list-riwayat-div">
              <ul class="list-group list-group-flush" id="list-riwayat">
                <!-- is' riwayat pesanan -->
              </ul>
            </div>
          </div>
        </div>
        <!-- Begin Page Content -->
        <div class="container-fluid position-fixed r-0 t-0 vh100" style="width: calc(65% - 4.5rem);width: calc(65% - 4.5rem); background: #fff; border-left: 1px solid #e4e4e4;" >
          <div class="p-3 position-fixed t-0 bg-white" style="right:inherit; height: 4rem; width: inherit; z-index: 2;border-bottom: 1px solid #e4e4e4; border-left: 1px solid #e4e4e4;">
            <p class="font-weight-bold" id="title-page-riwayat" style="position: relative; top: 50%; transform: translateY(-50%);"></p>
          </div>
          <div style=" position: fixed;  right:inherit; top:4rem; background: #fff; height: calc(100vH - 4rem); width: inherit; overflow-y: scroll;" class="hide-scroll border-left" id="detail-page-riwayat">
            
          <!-- isi detail riwayat -->
          </div>
        </div>
      </div>

      <!-- PENGATURAN -->
      <div id="pengaturan" style="display: none">
        <div class="position-fixed t-0 " style="left:4.5rem; background: #fff; height: 100vh; width: 35%;" >
          <div class="position-fixed t-0 " style="left: inherit;  height: calc(100vh - 4rem); width: inherit;">
            <!-- LIST ORDER  -->
            <div class="p-3 border-left position-fixed t-0" style="left:inherit; background: transparent; height: 4rem; width: inherit; vertical-align: middle; border-bottom: 1px solid #eee; ">
              <p class="font-weight-bold" style="position: relative; top: 50%; transform: translateY(-50%);">Pengaturan</p>
            </div>

            <!-- ORDR LIST  -->
            <div style=" left:inherit; top:4rem;  background: transparent; height: calc(100vH - 4rem); width: inherit; overflow-y: auto" class="p-0 position-fixed hide-scroll  border-left">
              <ul class="list-group list-group-flush">
                <li class="list-group-item px-3 py-4 md-button" onclick="setHTMLDetailHalamanPengaturan('profil')">
                  <div class="d-flex">
                    <div class="mr-3">
                      <div class="card border-0 ">
                        <div data-index="2" class="bd-placeholder-img card-img-top bg-grey-low rounded" style="height:70px;width:70px">
                          <h3 id="initialUserHalamanPengaturan"></h3>
                        </div>
                      </div>
                    </div>
                    <div>
                      <p class="mb-0 font-weight-bold" id="namaUserHalamanPengaturan"></p>
                      <p class="mb-0"><small id="emailUserHalamanPengaturan"></small></p>
                      <p class="mb-0"><small class="text-primary">Ubah Profil</small></p>
                    </div>
                  </div>
                </li>
                <li class="list-group-item px-3 py-2 bg-grey-1">
                  <div class="m-0 text-default">Perangkat</div>
                </li>
                <li class="list-group-item px-3 py-4 md-button" onclick="setHTMLDetailHalamanPengaturan('printer')">
                  <div class="my-0 ml-4">Printer</div>
                </li>
                <li class="list-group-item px-3 py-4 border-bottom md-button" onclick="setHTMLDetailHalamanPengaturan('pengaturan_lanjutan')">
                  <div class="my-0 ml-4">Pengaturan Lanjutan</div>
                </li>
                <li class="list-group-item px-3 py-2 bg-grey-1">
                  <div class="m-0 text-default">General</div>
                </li>
                <li class="list-group-item px-3 py-4 border-bottom md-button"  onclick="setHTMLDetailHalamanPengaturan('sinkronisasi')">
                  <div class="my-0 ml-4">Sinkronisasi Data</div>
                </li>
                <li class="list-group-item px-3 py-2 bg-grey-1">
                  <div class="m-0 text-default">Bantuan</div>
                </li>
                <li class="list-group-item px-3 py-4 border-bottom md-button" onclick="setHTMLDetailHalamanPengaturan('syarat_penggunaan')">
                  <div class="my-0 ml-4">Syarat Penggunaan</div>
                </li>
                <li class="list-group-item px-3 py-4 border-bottom md-button" onclick="setHTMLDetailHalamanPengaturan('kebijakan_privasi')">
                  <div class="my-0 ml-4">Kebijakan Privasi</div>
                </li>
                <li class="list-group-item px-3 py-4 border-bottom md-button" onclick="setHTMLDetailHalamanPengaturan('tentang')">
                  <div class="my-0 ml-4">Tentang</div>
                </li>
                <li class="list-group-item px-3 py-3 border-bottom md-button" onclick="logoutUser()">
                  <div class="my-0 mx-0">
                    <div class="btn py-2 btn-outline-danger btn-block text-center">Keluar</div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Begin Page Content -->
        <div class="container-fluid position-fixed r-0 t-0 vh100" style="width: calc(65% - 4.5rem); " >
          <!-- isi detail halaman pengaturan -->
          <div class="p-3 position-fixed t-0 bg-white" style="right:inherit; height: 4rem; width: inherit; z-index: 2;border-bottom: 1px solid #e4e4e4; border-left: 1px solid #e4e4e4;">
            <p class="font-weight-bold" id="title-page-pengaturan" style="position: relative; top: 50%; transform: translateY(-50%);">
              Printer
            </p>
          </div>
          <div style=" position: fixed;  right:inherit; top:4rem; background: #fff; height: calc(100vH - 7.5rem); width: inherit; border-left:solid 1px #e4e4e4; " class="p-2 hide-scroll" id="1detail-page-pengaturan">
            <!-- SUB PROFIL PAGE  -->
            <div id="sub-profil-page-pengaturan" style="position: fixed; right:inherit; top:inherit; background: #fff; height: calc(100vH - 4rem); width: inherit; overflow-y: auto; visibility: hidden;" class="p-4 hide-scroll page-pengaturan border-left">

              <!-- informasi akun -->
              <div class="card rounded-lg mb-3">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-12">
                      <h6>Informasi Akun</h6>
                      <hr/>
                      <form id="formUpdateProfil" >
                        <div class="p-2">
                          <div class="form-group mb-2">
                            <label>Nama Lengkap</label>
                            <input type="text" class="form-control w-75" id="edinputnameupdateprofil" name="name" placeholder="Masukkan Nama" maxlength="255" required>
                            <div class="invalid-feedback">
                              Masukkan Nama Lengkap dengan benar.
                            </div>
                          </div>
                          <div class="form-group mb-2">
                            <label>Email</label>
                            <input type="email" class="form-control w-75" id="edinputemailupdateprofil" name="email" readonly>
                          </div>
                          <div class="form-group mb-2">
                            <label>Kode Pin <small>(4 angka)</small></label>
                            <input type="text" class="form-control w-50" id="edinputpinupdateprofil" name="pin" placeholder="Ex: 1111"  minlength="4" maxlength="4"  required>

                            <div class="invalid-feedback">
                              Masukkan Kode Pin dengan parseInt(e.target.value)
                            </div>
                          </div>
                          <div class="form-group mb-4">
                            <label>Alamat</label>
                            <textarea class="form-control w-75" id="edinputalamatupdateprofil" name="alamat" placeholder="Alamat"></textarea>
                          </div>
                          <div class="form-group mb-2 w-75">
                            <button type="submit" class="btn btn-info px-5">Simpan</button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <!-- change password -->
              <div class="card rounded-lg">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-12">
                      <h6>Ganti Password</h6>
                      <hr/>
                      <form id="formUpdatePassword">
                        <div class="row">
                          <div class="col-6">
                            <div class="form-group  mb-2">
                              <label>Password Lama</label>
                              <input type="password" class="form-control" name="password_lama" placeholder="Masukkan Password Lama" maxlength="255" required>
                              <div class="invalid-feedback">
                                Masukkan Password Lama dengan benar.
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="row mb-3">
                          <div class="col-6">
                            <div class="form-group  mb-2">
                              <label>Password Baru</label>
                              <input type="password" class="form-control" name="password_baru" placeholder="Masukkan Password Baru" maxlength="255" required>
                              <small><i>*password harus berbeda dengan password lama</i></small>
                              <div class="invalid-feedback">
                                Masukkan Password Baru dengan benar.
                              </div>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="form-group  mb-2">
                              <label>Ulangi Password Baru</label>
                              <input type="password" class="form-control" name="confirm" placeholder="Masukkan Kembali Password Baru" maxlength="255" required>
                              <div class="invalid-feedback">
                                Masukkan Ulangi Password Baru dengan benar.
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col">
                            <button type="submit" class="btn btn-info px-5">Simpan</button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- SUB PRINTER PAGE -->
            <div id="sub-printer-page-pengaturan" style=" position: fixed; right:inherit; top:4rem; background: #fff; height: calc(100vH - 4rem); width: inherit; visibility: hidden;" class="p-0 page-pengaturan border-left">
              <ul class="list-group list-group-flush">
          <!--       <li class="list-group-item px-3 py-1" style="height:2rem;background: rgba(0, 142, 255, 0.26) !important; position: absolute; top: 0;left:0;right:0;">
                  <small id="jumlahPrinterTerkoneksiSubPrinterPagePengaturan">Tidak Ada Printer Terkoneksi</small>
                </li> -->
       <!--          <ul class="mui-tabs__bar hide-scroll m-0 " style="margin-bottom: 0 !important;">
                  <li class="opsi-kategori-menu" data-index="kasir"><a>Semua</a></li>
                  <li class="mui opsi-kategori-menu mui--is-active" data-index="dapur"><a>Buah-buahan</a></li>
                </ul> -->
                <div id="listPrinterSubPrinterPagePengaturan" class="hide-scroll" style="position: absolute; top: 0;left:0;right:0; bottom:3.6rem;overflow-y: scroll;">
                </div>
              </ul>
            </div>
            <div id="sub-pengaturan-lanjutan-page-pengaturan" style="position: fixed; right:inherit; top:inherit; background: #fff; height: calc(100vH - 4rem); width: inherit; overflow-y: auto; visibility: hidden;" class="p-0 hide-scroll page-pengaturan border-left">
              <ul class="list-group list-group-flush">
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Cetak Salinan Struk</p>
                    </div>
                    <div class="text-right">
                      <input type="checkbox" class="jtoggler" name="cetak_salinan_struk">
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Teruskan ke Printer Dapur</p>
                    </div>
                    <div class="text-right">
                      <input type="checkbox" class="jtoggler" name="teruskan_ke_printer_dapur">
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div id="sub-sinkronisasi-page-pengaturan" style="position: fixed; right:inherit; top:inherit; background: #fff; height: calc(100vH - 4rem); width: inherit; overflow-y: auto; visibility: hidden;" class="p-0 hide-scroll page-pengaturan border-left">
              <ul class="list-group list-group-flush">
                <li class="list-group-item py-3 list-sinkronisasi" data-index="outlet" style="background: #c9e7ff;">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Sinkronisasi Semua Data</p>
                      <p class="mb-0 text-999"><small id="teksSinkronisasiDataOutlet">Terakhir disinkronkan 10/09/2019 10:55 PM</small></p>
                    </div>
                    <div class="text-right">
                      <i class="fas fa-sync text-info btn-sinkronisasi" data-index="outlet" style="font-size: 1.6rem;line-height: 2.26;"></i>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3 list-sinkronisasi" data-index="pelanggan">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Sinkronisasi Pelanggan</p>
                      <p class="mb-0 text-999"><small id="teksSinkronisasiDataPelanggan">Terakhir disinkronkan 10/09/2019 10:55 PM</small></p>
                    </div>
                    <div class="text-right">
                      <i class="fas fa-sync text-info btn-sinkronisasi" data-index="pelanggan" style="font-size: 1.6rem;line-height: 2.26;"></i>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3 list-sinkronisasi" data-index="produk" >
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Sinkronisasi Menu</p>
                      <p class="mb-0 text-999"><small id="teksSinkronisasiDataProduk">Terakhir disinkronkan 10/09/2019 10:55 PM</small></p>
                    </div>
                    <div class="text-right">
                      <i class="fas fa-sync text-info btn-sinkronisasi" data-index="produk" style="font-size: 1.6rem;line-height: 2.26;"></i>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3 list-sinkronisasi" data-index="pesanan_tersimpan">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Sinkronisasi Pesanan Tersimpan</p>
                      <p class="mb-0 text-999"><small  id="teksSinkronisasiDataPesananTersimpan">Terakhir disinkronkan 10/09/2019 10:55 PM</small></p>
                    </div>
                    <div class="text-right">
                      <i class="fas fa-sync text-info btn-sinkronisasi" data-index="pesanan_tersimpan" style="font-size: 1.6rem;line-height: 2.26;"></i>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3 list-sinkronisasi" data-index="riwayat">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Sinkronisasi Riwayat</p>
                      <p class="mb-0 text-999"><small  id="teksSinkronisasiDataRiwayat">Terakhir disinkronkan 10/09/2019 10:55 PM</small></p>
                    </div>


                    <div class="text-right">
                      <i class="fas fa-sync text-info btn-sinkronisasi" data-index="riwayat" style="font-size: 1.6rem;line-height: 2.26;"></i>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div id="sub-tentang-page-pengaturan" style="position: fixed; right:inherit; top:inherit; background: #fff; height: calc(100vH - 4rem); width: inherit; overflow-y: auto; visibility: hidden;" class="p-0 hide-scroll page-pengaturan border-left">
              <ul class="list-group list-group-flush">
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;">
                      <p class="mb-0 font-weight-bold">Profil</p>
                      <p class="mb-0"><b>Kapcake</b> merupakan aplikasi <b>Point of Sale</b> yang dirancang untuk memecahkan masalah pendapatan yang fluktuatif pada bisnis bisnis café atau resto dengan memprioritaskan dan meningkatkan kepuasan pelanggan.</p>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;">
                      <p class="mb-0 font-weight-bold">Versi</p>
                      <p class="mb-0">1.0</p>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;">
                      <p class="mb-0 font-weight-bold">Website</p>
                      <p class="mb-0">https://www.kapcake.com</p>
                    </div>
                  </div>
                </li>
                <li class="list-group-item py-3">
                  <div class="d-flex">
                    <div class="text-left" style="line-height:1.75rem;width:90%">
                      <p class="mb-0 font-weight-bold">Kontak</p>
                      <p class="mb-0">(+62) 8525 6522 335</p>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
          <div style=" position: fixed; right:inherit; bottom:0;height: 3.5rem; width: inherit; background: #fff; box-shadow: 0 -2px 4px -4px #777;" id="divbtntambahprinter" class="py-2 px-3 hide-scroll text-right border-left border-top">
            <button class="btn btn-info rounded-sm px-5 h-100" id="btnTambahPrinter">Tambah Printer</button>
          </div>
        </div>
      </div><!-- END PENGATURAN -->

    </div><!-- END content wrapper Wrapper -->
  </div>

  <!-- Modal PEMESANAN-->
  <div class="modal" id="modalpemesanan" tabindex="-1" role="dialog" aria-labelledby="modalpemesanan" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content border-0" style="height: 90%;">
        <div class="modal-header">
          <h5 class="modal-title" style="margin: 0 auto;" id="modalpemesanantitle"></h5>
          <button style="margin: -15px !important;" type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body px-5" id="">
          <hr class="mt-1 mb-2" id="modalpemesananvariasihr"/>
          <h6 class="mb-3" id="modalpemesananvariasititle">Variasi</h6>
          <div class="row" id="modalpemesananvariasi">
          </div>

          <hr class="mt-3 mb-2"/>
          <h6 class="mb-3">Catatan dan Jumlah</h6>
          <div class="row">
            <div class="col-sm-8">
              <textarea class="form-control h-100" id="opsi-menu-catatan" placeholder="Masukkan Catatan"></textarea>
            </div>
            <div class="col-sm-4">
              <div class="d-flex flex-column">
                <div> 
                  <input type="text" class="form-control form-control-lg mb-1 text-center"  id="opsi-menu-jumlah">
                </div>
                <div>
                  <div class="btn-group btn-group-lg w-100" role="group" >
                    <button type="button" class="btn btn-outline-secondary" id="opsi-menu-minus">-</button>
                    <button type="button" class="btn btn-outline-secondary" id="opsi-menu-plus">+</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <hr class="mt-3 mb-2" id="modalpemesananjenispemesananhr"/>
          <h6 class="mb-3" id="modalpemesananjenispemesanantitle">Jenis Pemesanan</h6>
          <div class="row" id="modalpemesananjenispemesanan">

          </div>

        </div>
        <div class="d-flex rounded-0 w-100">
          <div class="font-weight-bold text-center active pointer py-3 bg-danger text-white w-50" id="opsi-menu-btn-hapus">Hapus</div>
          <div class="font-weight-bold text-center active pointer py-3 bg-info text-white w-50" id="opsi-menu-btn-simpan">Simpan</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal PILIH PELANGGAN-->
  <div class="modal" id="modalpilihpelanggan" tabindex="-1" role="dialog" aria-labelledby="modalpilihpelanggan" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content border-0" style="height: 90%">
        <div class="modal-header">
          <div class="row" style="width: 101% !important">
            <div class="col-4">
              <button class="btn btn-outline-info rounded-sm px-4" id="btnModalTutupPelanggan" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
            </div>
            <div class="col-4 text-center h5 mb-0 mt-1">Pelanggan</div>
            <div class="col-4 text-right pr-0">
              <button class="btn btn-outline-info rounded-sm px-4" id="btnModalKembaliPelanggan" type="button"> Kembali </button>
              <button class="btn btn-outline-info rounded-sm  px-4" id="buttonModalTambahPelanggan"> Tambah </button>
            </div>
          </div>
        </div>
        <ul class="list-group rounded-0" id="pencarianModalPelanggan">
          <li class="list-group-item p-0">
            <div class="input-group rounded-sm" >
              <div class="input-group-prepend border-0" style="background: transparent;">
                <span class="input-group-text border-0"  id="basic-addon1"  style="background: transparent;"><i class="fa fa-search"></i></span>
              </div>
              <input type="text" class="form-control border-0" placeholder="Pencarian..." id="pencarian_modal_pelanggan"  style="background: transparent; padding:.7rem .6rem;"/>
            </div>
          </li>
          <li class="list-group-item" style=" background: #e4e4e4;">
            <div class="row">
              <div class="col-4 font-weight-bold">Pelanggan</div>
              <div class="col-4 text-center font-weight-bold">No HP</div>
              <div class="col-4 text-right font-weight-bold">Email</div>
            </div>
          </li>
        </ul>
        <div class="modal-body p-0" id="modalpilihpelangganbodylist">
        </div>
        <div class="modal-body p-0" id="modalpilihpelangganbodyinput">
          <div class="row m-4">
            <div class="col-12 mb-3">
              <label>Nama Pelanggan</label>
              <input class="form-control rounded-sm" name="nama_pelanggan" type="text" placeholder="Nama">
            </div>
            <div class="col-6">
              <label>No Handphone (optional)</label>
              <input class="form-control rounded-sm" type="number" name="no_hp_pelanggan" placeholder="Ex: 08238980XXXX">
            </div>
            <div class="col-6">
              <label>Email (optional)</label>
              <input class="form-control rounded-sm" type="email" name="email_pelanggan" placeholder="Email ">
            </div>
          </div>
        </div>
        <ul class="list-group rounded-0 border-top">
          <li class="list-group-item font-weight-bold text-center bg-info text-white pointer" style="display: none;border-radius: 7px; margin:5px;padding:0.7rem;" id="buttonModalSimpanPelanggan">Simpan</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal PILIH DISKON-->
  <div class="modal" id="modalpilihdiskon" tabindex="-1" role="dialog" aria-labelledby="modalpilihdiskon" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content border-0" style="height: 90%">
        <div class="modal-header">
          <div class="row" style="width: 101% !important">
            <div class="col-3">
              <button class="btn btn-outline-info rounded-sm px-4" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
            </div>
            <div class="col-6 text-center h5 mb-0 mt-1">Diskon Transaksi</div>
            <div class="col-3 text-right pr-0">
              &nbsp;
            </div>
          </div>
        </div>
        <div class="modal-body p-0" id="modalpilihdiskonbody">

        </div>
        <ul class="list-group rounded-0 border-top">
          <li class="list-group-item font-weight-bold text-center bg-info text-white pointer" style="border-radius: 7px; margin:5px;padding:0.7rem;" id="buttonModalPilihDiskon">Pilih</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal PILIH BIAYA TAMBAHAN-->
  <div class="modal" id="modalpilihbiayatambahan" tabindex="-1" role="dialog" aria-labelledby="modalpilihbiayatambahan" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content border-0" style="height: 90%;">
        <div class="modal-header">
           <div class="row" style="width: 101% !important">
            <div class="col-3">
              <button class="btn btn-outline-info rounded-sm px-4" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
            </div>
            <div class="col-6 text-center h5 mb-0 mt-1">Biaya Tambahan</div>
            <div class="col-3 text-right pr-0">
              &nbsp;
            </div>
          </div>
        </div>
        <div class="modal-body p-0" id="modalpilihbiayatambahanbody">

        </div>
        <ul class="list-group rounded-0 border-top">
          <li class="list-group-item font-weight-bold text-center bg-info text-white pointer" style="border-radius: 7px; margin:5px;padding:0.7rem;" id="buttonModalPilihBiayaTambahan">Pilih</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal PILIH MEJA -->
  <div class="modal" id="modalpilihmeja" tabindex="-1" role="dialog" aria-labelledby="modalpilihmeja" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document" >
      <div class="modal-content border-0" style="height: 90%">
        <div class="modal-header">
          <div class="row" style="width: 101% !important">
            <div class="col-3">
              <button class="btn btn-outline-info rounded-sm px-4" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
            </div>
            <div class="col-6 text-center h5 mb-0 mt-1">Letak Meja</div>
            <div class="col-3 text-right pr-0">
              &nbsp;
            </div>
          </div>
        </div>
        <div class="modal-body p-4">
          <div class="p-0 mb-1 w-100 hide-scroll" style=" width: calc(65% - 4.5rem); background: #fff; overflow-x: scroll;position: relative;">
            <ul class="mui-tabs__bar hide-scroll m-0" id="listKategoriMeja">
            </ul>
          </div>
          <div id="listMeja">
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal PEMBAYARAN -->
  <div class="modal" id="modalpembayaran"  role="dialog" aria-labelledby="modalpembayaran" aria-hidden="true">
    <div class="modal-dialog modal-lg  modal-dialog-centered" role="document">
      <div class="modal-content border-0" style="height: 95vH;">
        <div class="modal-header">
          <div class="row" style="width: 101% !important">
            <div class="col-3">
              <button class="btn btn-outline-info rounded-sm px-4" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
            </div>
            <div class="col-6 text-center h5 mb-0 mt-1">Pembayaran</div>
            <div class="col-3 text-right pr-0">
              &nbsp;
            </div>
          </div>
        </div>
        <div class="modal-body p-0">
          <div class="d-flex w-100 h-100">

            <div class="position-relative border-right " style="width:calc(40% - 2px); height:100%; background: #fff;margin-left: 1px;">
              <div class="position-absolute  px-1 py-2" style="top:0; left: -1px; right: 0; height: 60px;">
                <div class="d-flex rounded position-relative h-100 py-2 px-4 mx-2" style="background: #e4e4e4;">
                  <div class="w-50 h-100 font-weight-bold" style="line-height: 1.9;" id="noPemesananPembayaran">#1-10001</div>
                  <div class="w-50 h-100 font-weight-bold text-right" style="line-height: 1.9;"><i class="fas fa-edit"></i> <span  id="mejaPembayaran">01</span></div>
                </div>
              </div>
              <div class="hide-scroll" style="position: absolute; height: auto; overflow-y: scroll; top:59px; bottom:217px; left: -1px; right: 0" id="listPesananPembayaran">
               
              </div>
              <div class="" style="position: absolute; height: 211px;  bottom: 0; width: auto; left:-1px; right:0;">
                <ul class="list-group">
                  <li class="list-group-item list-group-pembayaran-padding py-1 border-right-0 border-left-0">
                    <div class="d-flex">
                      <div class="w-50 text-left">Subtotal</div>
                      <div class="w-50 text-right" id="subtotalPembayaran">10.000</div>
                    </div>
                  </li>
                  <li class="list-group-item list-group-pembayaran-padding py-1 border-right-0 border-left-0" id="diskonListPembayaran">
                    <div class="d-flex">
                      <div class="w-50 text-left">Diskon</div>
                      <div class="w-50 text-right" id="diskonTotalPembayaran">10.000</div>
                    </div>
                  </li>
                  <li class="list-group-item list-group-pembayaran-padding py-1 border-right-0 border-left-0" id="biayaTambahanListPembayaran">
                    <div class="d-flex">
                      <div class="w-50 text-left">Biaya Tambahan</div>
                      <div class="w-50 text-right" id="biayaTambahanTotalPembayaran">10.000</div>
                    </div>
                  </li>
                  <li class="list-group-item list-group-pembayaran-padding py-1 border-right-0 border-left-0" id="pajakListPembayaran">
                    <div class="d-flex">
                      <div class="w-50 text-left">Pajak</div>
                      <div class="w-50 text-right" id="pajakTotalPembayaran">10.000</div>
                    </div>
                  </li>
                  <li class="list-group-item list-group-pembayaran-padding py-1 border-right-0 border-left-0">
                    <div class="d-flex">
                      <div class="w-50 text-left">Total</div>
                      <div class="w-50 text-right font-weight-bold" id="totalPembayaran">10.000</div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <div class="p-3 position-relative" style="width:calc(60% + 1px); background: #f4f4f4;">
              
              <div class="d-flex w-100 position-relative mb-3">
                <div class="input-group  rounded-sm border" style="background: #fff; ">
                  
                  <input 
                      type="number" 
                      class="form-control form-control-lg border-0" 
                      placeholder="Nominal Pembayaran"
                      onfocus="this.placeholder = ''"
                      onblur="this.placeholder = 'Nominal Pembayaran'" 
                      id="jumlahTunaiPembayaran" 
                      style="background: transparent;">
                  <div class="input-group-append border-0" style="background: transparent;">
                    <span class="input-group-text border-0" id="clearButtonNominalPembayaran" style="background: transparent;padding: 1rem 1.5rem;"><i class="fa fa-times"></i></span>
                  </div>
                </div>
              </div>

              <div class="w-100 position-relative">
                <div class="row mx-0">
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" id="uangpasPembayaran" data-reset="1" data-value="Uang Pas">Uang Pas</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="20000">20.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="50000">50.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="100000">100.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="1000">1.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="2000">2.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="5000">5.000</div>
                  </div>
                  <div class="col-lg-3 col-md-4 col-sm-6 px-1">
                    <div class="btn bg-cyan text-white btn-block py-2 mb-3 opsi-nominal-pembayaran" data-reset="0" data-value="10000">10.000</div>
                  </div>
                </div>
              </div>
              <div class="p-3" style="position: absolute; bottom: 0; width: auto; left: 0; right:0;">
                  <button class="btn btn-info btn-block" id="btnBayarPembayaran">Bayar</button>
              </div>
            </div>
          </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal TRANSAKSI SELESAI -->
<div class="modal" id="modaltransaksiselesai"  role="dialog" aria-labelledby="modaltransaksiselesai" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="margin: 0.7rem auto 8rem !important;">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title" style="margin: 0 auto;">Pembayaran</h5>
        <button style="margin: -15px !important;" type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-3 px-4 hide-scroll">
        <div class="row mb-3">
          <div class="col-8 mx-auto text-center">
            <img src="img/checked.png">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-8 mx-auto">
            <h1 class="text-center">Transaksi Selesai</h1>
            <p class="text-center">Uang Kembalian </p>
            <p class="text-center"><h4 class="font-weight-bold text-center kembalianPembayaran" id="kembalianSelesaiPembayaran"></h4></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-8 mx-auto">
            <div class="input-group mb-3">
              <input type="text" class="form-control form-control-lg" placeholder="Masukkan Alamat Email" id="inputKirimEmailStukTransaksi">
              <div class="input-group-append"  style="width: 30%">
                <button class="btn btn-info btn-lg px-3 btn-block" type="button" id="btnKirimEmailStukTransaksi">Kirim</button>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-8 mx-auto">
            <div class="d-flex " style="width: 100%">
              <div class="py-2 pr-2" style="width: 40%">
                <div class="btn btn-danger btn-lg btn-block" id="btnKembaliSelesaiPembayaran">Kembali</div>
              </div>
              <div class="py-2" style="width: 60%">
                <div class="btn btn-info btn-block btn-lg" id="btnPrintNotaSelesaiPembayaran">Print Struk</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal INFORMASI PESANAN DISIMPAN -->
<div class="modal" id="modalinformasipesanandisimpan" tabindex="-1" role="dialog" aria-labelledby="modalinformasipesanandisimpan" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title" style="margin: 0 auto;">Informasi</h5>
      </div>
      <div class="modal-body py-3 px-4 hide-scroll">
        <div class="row mb-3">
          <div class="col-8 mx-auto text-center">
            <img src="img/checked.png" style="width:30%">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col">
            <h4 class="text-center font-weight-bold">Pesanan berhasil disimpan</h4>
            <p class="text-center">Buka menu transaksi untuk melihat pesanan tersimpan</p>
          </div>
        </div>
        <div class="row">
          <div class="col-8 mx-auto">
            <div class="btn btn-danger btn-lg pointer btn-block" data-dismiss="modal">Kembali</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- KONFIRMASI PEMBATALAN PESANAN TERSIMPAN -->
<div class="modal" id="modalkonfirmasihapuspesanantersimpan" tabindex="-1" role="dialog" aria-labelledby="modalkonfirmasihapuspesanantersimpan" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title" style="margin: 0 auto;">Konfirmasi Pembatalan</h5>
        <button style="margin: -15px !important;" type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-3 px-4 hide-scroll">
        <div class="row mb-3">
          <div class="col-8 mx-auto text-center">
            <img src="img/warning.png">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col">
            <h4 class="text-center font-weight-bold">Batalkan pesanan ?</h4>
          </div>
        </div>
        <div class="row">
          <div class="col-8 mx-auto">
            <div class="d-flex " style="width: 100%">
              <div class="py-2 pr-2" style="width: 50%">
                <div class="btn btn-success btn-lg btn-block" data-dismiss="modal">Kembali</div>
              </div>
              <div class="py-2" style="width: 50%">
                <div class="btn btn-danger btn-lg btn-block pointer" id="btnModalHapusPesananTersimpan" data-index="0">Hapus</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DAFTAR BLUETOOTH TERDETEKSI -->
<div class="modal" id="modalprinter" tabindex="-1" role="dialog" aria-labelledby="modalprinter" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
    <div class="modal-content border-0" >
      <div class="modal-header">
        <div class="row" style="width: 101% !important">
          <div class="col-3">
            <button class="btn btn-outline-info rounded-sm px-4" type="button"  data-dismiss="modal" aria-label="Close"> Tutup </button>
          </div>
          <div class="col-6 text-center h5 mb-0 mt-1"id="modalprintertitle">Printer</div>
          <div class="col-3 text-right pr-0">
            <button class="btn btn-outline-info rounded-sm px-4" id="btnModalPrinterKembali" type="button"> Kembali </button>
          </div>
        </div>
      </div>
      <div class="modal-body p-0" >
        <ul class="list-group rounded-0" id="modalprinterbodylist">
        </ul>
        <div id="modalprinterbodyinput" class="px-4 py-3">
          <form id="formModalPrinter" data-method="add">
            <div class="row mb-2">
              <div class="col">
                <label><small>Nama Printer</small></label>
                <input type="text" name="nama_printer" class="form-control" id="edNamaModalPrinter" placeholder="Masukkan nama printer" required>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-6">
                <label><small>Jenis Printer</small></label>
                <select class="form-control" name="jenis_printer" id="edJenisModalPrinter" required>
                  <option value="Umum">Umum</option>
                  <option value="Epson">Epson</option>
                  <option value="StarMicronics">StarMicronics</option>
                  <option value="MUNBYN">MUNBYN</option>
                  <option value="VSC">VSC</option>
                  <option value="Panda">Panda</option>
                  <option value="EOM-POS">EOM-POS</option>
                  <option value="ZKTeco">ZKTeco</option>
                  <option value="Arkscan">Arkscan</option>
                </select>
              </div>
              <div class="col-6">
                <label><small>Lebar Kertas (mm)</small></label>
                <select class="form-control" name="lebar_kertas" id="edLebarKertasModalPrinter">
                  <option value="58" selected="selected">58 mm</option>
                  <option value="80">80 mm</option>
                </select>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col">
                <label><small>Alamat Bluetooth</small></label>
                <input type="text" class="form-control" name="mac" id="edMacModalPrinter" placeholder="Masukkan MAC Address Bluetooth printer" required>
              </div>
            </div>

            <div class="mt-4" id="modalprinterbuttoninput">
              <div class="d-flex">
                <div class="w-50 pr-2">

                  <button type="reset" class="btn pointer w-100 py-2 btn-outline-danger" id="btnHapusInputPrinter">Hapus</button>
                  <button type="reset" class="btn pointer w-100 py-2 btn-outline-secondary" id="btnBatalInputPrinter">Batal</button>
                </div>
                <div class="w-50 pl-2">
                  <button type="submit" class="btn pointer w-100 py-2 btn-info">Simpan</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="p-3" id="modalprinterbuttonlist">
        <div class="d-flex">
          <div class="w-50 pr-2">
            <button type="button" class="btn pointer btn-block py-2 btn-outline-info" id="btnModalPilihPrinterInputManual">Input Manual</button>
          </div>
          <div class="w-50 pl-2">
            <button type="button" class="btn pointer btn-block py-2 btn-info" id="btnModalPilihPrinterSambungkan">Sambungkan</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- ./DAFTAR BLUETOOTH TERDETEKSI -->

<!-- KONFIRMASI PEMBATALAN PESANAN TERSIMPAN -->
<div class="modal" id="modalkonfirmasihapusprinter" tabindex="-1" role="dialog" aria-labelledby="modalkonfirmasihapusprinter" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title" style="margin: 0 auto;">Konfirmasi Hapus Printer</h5>
        <button style="margin: -15px !important;" type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-3 px-4 hide-scroll">
        <div class="row mb-3">
          <div class="col-8 mx-auto text-center">
            <img src="img/warning.png">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col">
            <h4 class="text-center font-weight-bold">Hapus printer ?</h4>
          </div>
        </div>
        <div class="row">
          <div class="col-8 mx-auto">
            <div class="d-flex " style="width: 100%">
              <div class="py-2 pr-2" style="width: 50%">
                <div class="btn btn-success  btn-block" data-dismiss="modal">Kembali</div>
              </div>
              <div class="py-2" style="width: 50%">
                <div class="btn btn-danger btn-block pointer" id="btnModalHapusPrinter" data-index="0">Hapus</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      <!-- Custom scripts for all pages-->
<script 
  src="https://browser.sentry-cdn.com/5.6.3/bundle.min.js" 
  integrity="sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho" 
  crossorigin="anonymous">
</script>

<script type="text/javascript">

    var urlDomain = "https://api.telkomreg7.id/";
    $('.jtoggler').jtoggler();
            
    var sidebarToggleOpacity = false;
    $('#sidebarToggle , #sidebarToggleOpacity').click(function(){
      if(sidebarToggleOpacity === false)
        $('#sidebarToggleOpacity').css('display','block');
      else
        $('#sidebarToggleOpacity').css('display','none');
      sidebarToggleOpacity = !sidebarToggleOpacity;
    });
      
    /// aplikasi only
    function loginUser(data, no_pemesanan){
      // android.CustomToast(JSON.stringify(data.user));
      setStorage(data);
      if(getDataUser().jumlah_akses_outlet  >= 1)
       setDataAwal();
     // $('#initialUserHalamanPengaturan').html(getInitials(data.user.nama));
      $('#initialUserHalamanPengaturan').html(getInitials(data.user.nama));
      $('#namaUserHalamanPengaturan').html(data.user.nama);
      $('#emailUserHalamanPengaturan').html(data.user.email);
      localStorage.setItem(
        'no_urut_pesanan', 
        JSON.stringify(parseInt(no_pemesanan) === 0 ? 1 : no_pemesanan )
      );

      let tglSinkronisasi = datetimeEvent();
      $('#teksSinkronisasiDataOutlet').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
      $('#teksSinkronisasiDataPelanggan').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
      $('#teksSinkronisasiDataProduk').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
      $('#teksSinkronisasiDataPesananTersimpan').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
      $('#teksSinkronisasiDataRiwayat').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
    }

     /// aplikasi only
    function logoutToPIN(){
      android.logoutToPIN();
    }

    /// aplikasi only
    function logoutUser(){
      android.logout();
    }

    /// web only
    var login = function(){
      $.ajax({
        method: 'POST',
        url: urlDomain + 'api/kasir/login',
        header:{
          'Accept' : 'application/json'
        },
        data: {
          email: "rra.rickyresky@gmail.com",
          password: "testestes",
          operating_system: "android",
          mac: "02:00:00:00:00:00",
        },
        success: function(data){
          loginUser(data,0);
        },
        error :function(res){
          alert('err');
        }
      });
    }
    // web only
    // login();

    var sidebarToggleOpacity = false;
    $('#sidebarToggle , #sidebarToggleOpacity').click(function(){
      if(sidebarToggleOpacity === false)
        $('#sidebarToggleOpacity').css('display','block');
      else
        $('#sidebarToggleOpacity').css('display','none');
      sidebarToggleOpacity = !sidebarToggleOpacity;
    });
    $('#kasir').show();
    $('#pesanan').hide();
    $('#riwayat').hide();
    $('#pengaturan').hide();
///// PROSES PEMBUATAN STORAGE ///////
function setStorage(res){
 /**
 * Storage user menyimpan data user yang telah login
 * dan digunakan dalam menu profil serta mengikutsertakan data khusus id user
 * pada fungsi auth digunakan untuk menentukan level usernya 
 */
 let user = res.user;
 let dataUser = {
   id : user.id,
   nama: user.nama,
   email: user.email,
   telpon: user.telpon,
   alamat: user.alamat,
   pin: user.pin,
   no_urut: user.no_urut,
   is_super_admmin: user.is_super_admmin,
   bisnis_id: user.bisnis_id,
   jumlah_akses_outlet: user.outlet.length,
   no_urut: user.no_urut,
 };
 localStorage.setItem('user', JSON.stringify(dataUser));

     /**
     * Storage Outlet untuk menyimpan outlet yang dapat diakses oleh user
     */
     let outlet = user.outlet;
     localStorage.setItem('outlet', JSON.stringify(outlet));
     localStorage.setItem('perangkat', JSON.stringify(res.perangkat));

     localStorage.setItem('outlet_terpilih', JSON.stringify([]));



     /**
     * Storage pesanan untuk menyimpan pesanan sementara sebelum dibayar
     */
     localStorage.setItem('pesanan', JSON.stringify([]));

     /**
     * Storage riwayat untuk menyimpan riwayat pesanan
     */
     localStorage.setItem('riwayat', JSON.stringify([]));


     /**
     * Storage printer untuk menyimpan printer yang telah diinput atau di koneksikan
     */
     localStorage.setItem('printer', JSON.stringify([]));


     /**
     *  Storage data menyimpan data lain yang akan digunakan dalam aplikasi
     *  dan menyimpan data variable apabila aplikasi closed 
     */
     let dataSet = { 
       no_pemesanan: 0,
       outlet_terpilih_id : outlet[0].id,
       kategori_menu_terpilih : 0,
       kategori_meja_terpilih : 0 
     }
     localStorage.setItem('data', JSON.stringify(dataSet));

     /**
     *  Storage token dikhususkan untuk menyimpan token akses data API
     *  Storage token akan dikosongkan apabila user telah logout
     */
     localStorage.setItem('token', res.token);

     /**
     * Storage pesanan terfokus berfungsi sebagai penyimpanan sementara data pesanan yang barusaja dipesan atau pesanan yang baru saja dilanjutkan
     */
     resetStoragePesananTerfokus();
   }

   function getToken(){
     return localStorage.getItem('token');
   }

   function getPerangkat(){
     return JSON.parse(localStorage.getItem('perangkat'));
   }

   // function setOutletTerpilih(id){
   //   var user = JSON.parse(localStorage.getItem('user'));
   //   user.outlet_terpilih_id = id;
   //   localStorage.setItem('user', JSON.stringify(user));
   // }

   function getOutletTerpilih(){
     let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
     return data.id_outlet;
   }

var menuOpsi = []; //variable ini untuk simpan data menu dari hasi get setdata awal agar tidak perlu load lagi dari storage

function setDataAwal(){
    var outlet_terpilih_id = JSON.parse(localStorage.getItem('data')).outlet_terpilih_id;  // ini sudah benar hanya perlu ditambahkan  di anroid save outlet terpilih
    var _perangkat = JSON.parse(localStorage.getItem('perangkat'));  // ini sudah benar hanya perlu ditambahkan  di anroid save outlet terpilih
    $.ajax({
     method: 'GET',
     url: urlDomain + 'api/kasir/outlet',
     headers: {
       'Accept':'application/json',
       'Content-Type':'application/json',
       'Authorization':'Bearer ' + getToken(),
     },
     dataType: 'json',
     data: {
       outlet_id : outlet_terpilih_id,
       perangkat_id : _perangkat.id_perangkat
     },
     success: async function(data){

       localStorage.setItem('menu', JSON.stringify(data.menu));
       localStorage.setItem('kategori_menu', JSON.stringify(data.kategori_menu));
       await setHTMLKategoriMenu();
       await setHTMLMenu();
       menuOpsi = data.menu;
       setDefaultPesanan();
     $('#kasir').show();      // <<<<<<<     ini masih dipake yahhh
        if(!data.printer) data.printer = [];
        if(!data.meja) data.meja = [];
        
        for(let i = 0; i < data.meja.length; i++){
          data.meja[i]['is_tersedia'] = 1;
        }

        //proses ini bisa setelahnya set data
        localStorage.setItem('outlet_terpilih', JSON.stringify(data.outlet));
        localStorage.setItem('jenis_pemesanan', JSON.stringify(data.jenis_pemesanan));
        localStorage.setItem('kategori_meja', JSON.stringify(data.kategori_meja));

        localStorage.setItem('meja', JSON.stringify(data.meja));
        localStorage.setItem('diskon', JSON.stringify(data.diskon));
        localStorage.setItem('biaya_tambahan', JSON.stringify(data.biaya_tambahan));
        localStorage.setItem('pajak', JSON.stringify(data.pajak));
        localStorage.setItem('pelanggan', JSON.stringify(data.pelanggan));

        let dataPemesanan = setDataPemesananStorageFormat(data.pemesanan);
        localStorage.setItem('pesanan', JSON.stringify(dataPemesanan));

        localStorage.setItem('riwayat', JSON.stringify(data.penjualan));
        if(data.penjualan.length > 0){
          _stateRiwayat.tanggal_max = data.penjualan[0]['tanggal_proses'];
          _stateRiwayat.waktu_max = data.penjualan[0]['waktu_proses'];
          _stateRiwayat.nomor_urut = data.penjualan.length;
        }

        localStorage.setItem('printer', JSON.stringify(data.printer));

        if(data.setting)
          localStorage.setItem('setting', JSON.stringify(data.setting));

          setHTMLKategoriMeja();
          if(data.kategori_meja && data.kategori_meja.length > 0){
            _state.kategoriMejaTerpilih = data.kategori_meja[0].id_kategori_meja;
            pencarianMeja();
          }
          setHTMLDiskon();
          setHTMLBiayaTambahan();
          setHTMLPelanggan();
          setHTMLRiwayat();
          setHTMLListPrinterSubPage();
          setDefaultHalamanPengaturan();
       }
     });

  }

// /////// /////// /////// /////// PAGE PAGE PAGE PAGE PAGE PAGE PAGE PAGE PAGE  /////////////////////////////////////
var _statePage = {
  pesanan: JSON.parse(localStorage.getItem('pesanan')),
  riwayat: JSON.parse(localStorage.getItem('riwayat'))
}

async function page(menu){
  var menuList = ['kasir', 'pesanan', 'riwayat', 'pengaturan'];
  if(menu === 'kasir'){
    await setReOpenPesananTerfokus();
  }else if(menu == 'pesanan'){
    setHTMLPesananTersimpan();
    setEmptyDetailPesananTersimpan();
  }else if(menu == 'pengaturan'){
    setDefaultHalamanPengaturan();

  }
  _statePage = {
    pesanan: JSON.parse(localStorage.getItem('pesanan')),
    riwayat: JSON.parse(localStorage.getItem('riwayat'))
  }
  for(let i = 0; i < menuList.length; i++){
    if(menuList[i] === menu) $('#'+menu).show();
    else $('#'+menuList[i]).hide();
  }
}
//////////***************?????????????????????????  PROSES HALAMAN KASIR  ??????????????????????**************//////////
var _state = {
  kategoriMenuTerpilih : 0,
  pencarianMenu : '',
  mejaTerpilih : 0,
  menuTerpilih : 0,
  variasiTerpilih : 0,
  jenisPemesananTerpilih : 0,
  catatanTerpilih : '',
  jumlahTerpilih : 1,
  pelangganTerpilih : 0,
  diskonTerpilih : 0,
  biayaTambahanTerpilih : 0,

  ///// PEMBAYARAN STATE
  nominalPembayaran:0,
  resetNominalPembayaran:0,
  kembalianPembayaran:0,

};

function getDataUser(){
 return JSON.parse(localStorage.getItem('user'));
}

function getPesananTerfokus(){
 return JSON.parse(localStorage.getItem('pesanan_terfokus'));
}

/*********** KATEGORI MENU *************/
function setHTMLKategoriMenu(){
 let data = JSON.parse(localStorage.getItem('kategori_menu'));
 var htmlList = '<li  class="mui--is-active opsi-kategori-menu" data-index="0">'+
 '<a>Semua</a>'+
 '</li>'; 
 for (var i = 0; i < data.length; i++) {
   htmlList = htmlList + '<li class="mui opsi-kategori-menu" data-index="'+data[i].id_kategori_menu+'">'+
   '<a>'+data[i].nama_kategori_menu+'</a>'+
   '</li>';
 }
 $('#listKategoriMenu').html(htmlList);
}

function setStorageKategoriMenuTerpilih(){
 let data = JSON.parse(localStorage.getItem('data'));
 data.kategori_menu_terpilih = _state.kategoriMenuTerpilih;
 localStorage.setItem('data', JSON.stringify(data));
}

$('body').on('click','.opsi-kategori-menu',function(){
 _state.kategoriMenuTerpilih = parseInt($(this).attr('data-index'));
 $('.opsi-kategori-menu').removeClass("mui--is-active");
 $(this).addClass("mui--is-active");
   pencarianMenu();
  setStorageKategoriMenuTerpilih(); //hanya proses simpan 
});



/*********** MENU *************/
function setHTMLMenu(menu = [], filtered = false){
  if(filtered == false)
    menu = JSON.parse(localStorage.getItem('menu'));
 var htmlList ="";
 for (var i = 0; i < menu.length; i++) {
  htmlList = htmlList + '<div class="px-1 col-md-3 col-sm-4 ">'+
    '<div class="card mb-3 border-0 opsi-menu card-box p-2" data-index="'+menu[i]['id_menu']+'">'+
      '<div data-index="'+i+'" class="bd-placeholder-img card-img-top bg-grey-low inisial-menu rounded-lg" style="height:100px;width:100%;display:none;">'+
        '<h3>'+getInitials(menu[i]['nama_menu'])+'</h3>'+
      '</div>' +
        '<img data-index="'+i+'" src="'+(menu[i]['gambar'].length > 0 ? menu[i]['gambar'][1]['link']:'')+'" class="card-img-top rounded-lg gambar" alt="'+menu[i]['nama_menu']+'" onerror="gambarOnError(this)" />'+
      '<div class="card-body px-0 py-2">'+
        '<label class="mb-1"><b>'+menu[i]['nama_menu']+'</b></label>'+
        '<p class="card-text">'+ (menu[i]['variasi'].length > 1 ? menu[i]['variasi'].length+' Variasi' : 'Rp '+addCommas( menu[i]['variasi'][0]['harga'] ) )  +'</p>'+
      '</div>'+
    '</div>'+
  '</div>'; 
  }
  $('#listMenu').html(htmlList);
}

function gambarOnError(data){
  $('.gambar[data-index='+data.getAttribute('data-index')+']').hide();
  setTimeout(function(){ 
    $('.inisial-menu[data-index='+data.getAttribute('data-index')+']').show();
  }, 120);
}




/*********** PENCARIAN MENU **************/
function pencarianMenu(){
  let menu = menuOpsi;
  if(_state.pencarianMenu !== '' && _state.pencarianMenu !== null && _state.pencarianMenu.length >= 1 ){
    menu = menu.filter(item => (item.nama_menu.toLowerCase()).indexOf(_state.pencarianMenu) > -1);
  }
  if(_state.kategoriMenuTerpilih !== 0)
    menu = menu.filter(value => value.kategori_menu_id === _state.kategoriMenuTerpilih);
  setHTMLMenu(menu, true);
}
$('body').on('keyup','#pencarianMenu',async function(){
  _state.pencarianMenu = await $(this).val();
  await pencarianMenu();
});
$('#pencarianMenuCrossButton').click(function(){
  _state.pencarianMenu = '';
  $('#pencarianMenu').val('');
  pencarianMenu();
});

/***********MODAL PEMESANAN**************/
    // modalpemesanan
    $('body').on('click','.opsi-menu',function(){
      modalMenuOpsi(parseInt($(this).attr('data-index')));
    });

    function modalMenuOpsi(dataIndex){
      _state.menuTerpilih = dataIndex;
      let data = JSON.parse(localStorage.getItem('menu'));
      var menu = data.find(d => parseInt(d.id_menu) === parseInt(_state.menuTerpilih) );

      $('#modalpemesanantitle').html(menu.nama_menu);

      /// JENIS PEMESANAN
      let jenisPemesanan = menu.tipe_penjualan;
      $('#modalpemesananjenispemesananhr').hide();
      $('#modalpemesananjenispemesanantitle').hide();
      $('#modalpemesananjenispemesanan').hide();

      if(jenisPemesanan.length >= 1 ){
        var htmlListJenisPemesanan = '';
        for(var a = 0; a < jenisPemesanan.length; a++){
         htmlListJenisPemesanan = htmlListJenisPemesanan + 
         '<div class="col-6 mb-2">'+
         '<div class="d-flex rounded border border-info p-3 opsi-menu-jenis-pemesanan'+( a === 0 ? ' bg-info text-white ':'' )+'" data-index="'+jenisPemesanan[a]['tipe_penjualan_id']+'">'+
         '<div class="text-left">'+jenisPemesanan[a]['tipe_penjualan']['nama_tipe_penjualan']+'</div>'+
         '</div>'+
         '</div>';
        }
       $('#modalpemesananjenispemesananhr').show();
       $('#modalpemesananjenispemesanantitle').show();
       $('#modalpemesananjenispemesanan').show();
       $('#modalpemesananjenispemesanan').html(htmlListJenisPemesanan);
       _state.jenisPemesananTerpilih = jenisPemesanan[0]['tipe_penjualan_id'];
     }else if(jenisPemesanan.length === 1 ){
       _state.jenisPemesananTerpilih = jenisPemesanan[0]['tipe_penjualan_id'];
     }else{
      _state.jenisPemesananTerpilih = 0;
    }

     /// VARIASI MENU
     $('#modalpemesananvariasihr').hide();
     $('#modalpemesananvariasititle').hide();
     $('#modalpemesananvariasi').hide();
     var htmlListVariasi = '';
     let variasi = menu.variasi;
     if(variasi.length > 1){
       $('#modalpemesananvariasihr').show();
       $('#modalpemesananvariasititle').show();
       $('#modalpemesananvariasi').show();
       for(var a = 0; a < variasi.length; a++){
        htmlListVariasi = htmlListVariasi + 
        '<div class="col-6 mb-2">'+
        '<div class="d-flex rounded border border-info opsi-menu-variasi p-3 '+(a === 0 ? ' bg-info text-white ': '')+'" data-index="'+variasi[a]['id_variasi_menu']+'">'+
        '<div class="w-50 text-left">'+variasi[a]['nama_variasi_menu']+'</div>'+
        '<div class="w-50 text-right">Rp '+addCommas(variasi[a]['harga'])+'</div>'+
        '</div>'+
        '</div>';
      }
      $('#modalpemesananvariasi').html(htmlListVariasi);
      _state.variasiTerpilih = variasi[0]['id_variasi_menu'];
    }else if(variasi.length === 1){
      _state.variasiTerpilih = variasi[0]['id_variasi_menu'];
    }else{
      _state.variasiTerpilih = 0;
    }

    $('#opsi-menu-jumlah').val('1');
    $('#opsi-menu-btn-hapus').hide();
    $('#opsi-menu-btn-simpan').html('Tambahkan');
    $('#opsi-menu-btn-simpan').removeClass('w-50');
    $('#opsi-menu-btn-simpan').addClass('w-100');

    $('#modalpemesanan').modal('show');
  }

  $('body').on('click','.opsi-menu-jenis-pemesanan',function(){
   _state.jenisPemesananTerpilih = parseInt($(this).attr('data-index'));
   $('.opsi-menu-jenis-pemesanan').removeClass(" bg-info text-white");
   $(this).addClass("bg-info text-white");
 });

  $('body').on('click','.opsi-menu-variasi',function(){
   _state.variasiTerpilih = parseInt($(this).attr('data-index'));
   $('.opsi-menu-variasi').removeClass(" bg-info text-white");
   $(this).addClass("bg-info text-white");
 });

  $('body').on('click','#opsi-menu-minus',function(){
    _state.jumlahTerpilih = parseInt($('#opsi-menu-jumlah').val());
    if(_state.jumlahTerpilih > 1)
      _state.jumlahTerpilih = _state.jumlahTerpilih - 1;

    $('#opsi-menu-jumlah').val(_state.jumlahTerpilih);
  });

  $('body').on('click','#opsi-menu-plus',function(){
    _state.jumlahTerpilih = parseInt($('#opsi-menu-jumlah').val());
    _state.jumlahTerpilih = _state.jumlahTerpilih + 1;
    $('#opsi-menu-jumlah').val(_state.jumlahTerpilih);
  });

  $('#opsi-menu-jumlah').keyup(function(){
    if (/\D/g.test(this.value))
    {
      // Filter non-digits from input value.
      this.value = this.value.replace(/\D/g, '');
    }
    if(this.value < 1 )this.value = 1;
    if(this.value > 999 )this.value = 999;
    _state.jumlahTerpilih = parseInt(this.value);
  });

  $('body').on('change','#opsi-menu-catatan',function(){
   _state.catatanTerpilih = $('#opsi-menu-catatan').val();
 });

  /// Event KLik Tambahkan
  $('body').on('click','#opsi-menu-btn-simpan', async function(){
    let menus = await JSON.parse(localStorage.getItem('menu'));
    let menu = await menus.find(m => m.id_menu === _state.menuTerpilih);
    /// menyeleksi apakah menu yang di simpan memiliki jenis pemesanan atau tidak
    if( menu.tipe_penjualan.length >= 1 && _state.jenisPemesananTerpilih == 0) return;

    //proses mencari dan mengambil data tipe penjualan
    let tipePenjualan = {};
    if(menu.tipe_penjualan !== undefined && menu.tipe_penjualan.length >= 1)
      tipePenjualan = await menu.tipe_penjualan.find(t => parseInt(t.tipe_penjualan_id) === parseInt(_state.jenisPemesananTerpilih) ).tipe_penjualan; 

    let harga = 0;
    let variasi = menu.variasi.find(v => v.id_variasi_menu === _state.variasiTerpilih);
    if(variasi.tipe_penjualan.length > 0)
     harga = (variasi.tipe_penjualan.find(h => h.tipe_penjualan_id === tipePenjualan.id_tipe_penjualan)).harga;
   else
     harga = variasi.harga;
   /// set data menu untuk 1 list nya
   let menuData = await {
     'menu_id' : menu.id_menu,
     'nama_menu' : menu.nama_menu,
     'variasi_menu_id' : variasi.id_variasi_menu,
     'nama_variasi_menu' : menu.variasi.length > 1 ? variasi.nama_variasi_menu : '',
     'tipe_penjualan_id' : tipePenjualan.id_tipe_penjualan !== undefined ? tipePenjualan.id_tipe_penjualan : 0,
     'nama_tipe_penjualan' : tipePenjualan.id_tipe_penjualan !== undefined ? tipePenjualan.nama_tipe_penjualan : '',
     'jumlah' : _state.jumlahTerpilih,
     'harga' : harga,
     'total' : parseInt(_state.jumlahTerpilih) * parseInt(harga),
     'catatan': _state.catatanTerpilih
   };
    ///// mengambil data pesanan terfokus untuk dibuatkan defaultnya
    let data = JSON.parse(localStorage.getItem('pesanan_terfokus'));
    if(data.pesanan.length === 0 ){
      let nomorPesanan = await setNomorPesanan(data, true);
      data.is_uploaded = 0;
      data.no_pemesanan = nomorPesanan.no_pemesanan; 
      data.kode_pemesanan = nomorPesanan.kode_pemesanan; 
      $('#kode_pemesanan').html('#'+data.no_pemesanan);
    }
   /// jika pesanan belum ada maka html dikosongkan
   if( data.pesanan.length < 1 ){
     await setBlankListPesanan();
   }

   var jmlMenu = 0;
   /// mengecek apakah data pesanan dengan variasi dan tipe penjualan nya sama
  $.each( data.pesanan, function( key, m ) {
      if( 
        (m.menu_id === menuData.menu_id) && 
        (m.variasi_menu_id === menuData.variasi_menu_id) && 
        (m.tipe_penjualan_id === menuData.tipe_penjualan_id)
        ){
        data.pesanan[key]['jumlah'] = data.pesanan[key]['jumlah'] + menuData.jumlah; 
        data.pesanan[key]['total'] = data.pesanan[key]['jumlah'] * data.pesanan[key]['harga']; 

        jmlMenu++; // variable untuk menyimpan pesanan yang terduplikat
      }
  });
  /// mengecek jumlah menu duplikat jika 0 maka akan menambahkan list baru
  if(jmlMenu === 0)
    data.pesanan.push(menuData);


  data.subtotal = 0;
  data.total_item = 0;
  $.each( data.pesanan, function( key, p ) {
    data.subtotal = data.subtotal + parseInt(p.total);
    data.total_item = data.total_item + parseInt(p.jumlah);
  });
  let pajak = JSON.parse(localStorage.getItem('pajak'));
  if(pajak.id_pajak){
    data.pajak_id = pajak.id_pajak;
    data.nama_pajak = pajak.nama_pajak;
    data.jumlah_pajak = pajak.jumlah;
  }
  await localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
  await setListPesanan(data);

  $('#modalpemesanan').modal('hide');

  _state.menuTerpilih = 0;
  _state.variasiTerpilih = 0;
  _state.jenisPemesananTerpilih = 0;
  _state.catatanTerpilih = '';
  _state.jumlahTerpilih = 1;

 }); //batas button tambah menu

async function setListPesanan(data = null){
  // mengambil data pesanan terfokus jika tanpa parameter
  if(data === null){
    data = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
  }
  await $('#btnModalHapusPesananTersimpan').attr('data-index', data.kode_pemesanan);

  if(data.pesanan.length === 0){
    setDefaultPesanan();
    return;
  }
  /// mengambil data jenis pemesanan 
  let jenisPemesanan = await JSON.parse(localStorage.getItem('jenis_pemesanan'));
  /// mengecek apakah data jenis pemesanan kosong
  if(jenisPemesanan.length === 0) jenisPemesanan = await [{id_tipe_penjualan: 0, nama_tipe_penjualan: ''}];
  /// menyusun pesanan sesuai jenis pesanan masing2 menu
  let pesanan = await [];
  for(let i = 0; i < jenisPemesanan.length; i++){
    pesanan[i] = await {
      id_tipe_penjualan: jenisPemesanan[i].id_tipe_penjualan,
      nama_tipe_penjualan: jenisPemesanan[i].nama_tipe_penjualan,
      menu: [],
    };
    for(let a = 0; a < data.pesanan.length; a++){
      if(pesanan[i].id_tipe_penjualan === data.pesanan[a].tipe_penjualan_id){
        await pesanan[i].menu.push(data.pesanan[a]);
      }
    }
  }

  let htmlListPesanan = '';
  $.each(pesanan, function( key, m ) {
    if(m.id_tipe_penjualan !== 0 && m.menu.length >= 1)
    htmlListPesanan = htmlListPesanan + '<li class="list-group-item border-0 pt-3 pb-2 text-center" data-index="'+ m.id_tipe_penjualan +'">-'+ m.nama_tipe_penjualan +'-</li>';
    $.each( m.menu, function( k, menu) {
      htmlListPesanan = htmlListPesanan + '<li class="list-group-item border-0 p-3 list-pesanan-menu" data-index="'+ menu.menu_id +'">'+
      '<div class="d-flex">'+
      '<div class="text-left" style="width: 15%; "><b class="badge-pesanan">'+menu.jumlah+'</b></div>'+
      '<div class="pr-1 flex-grow-1 text-left" style="width: 45%">'+
      '<div class="text-truncate font-weight-bold">'+menu.nama_menu+'</div>'+
      (menu.nama_variasi_menu !== '' && menu.nama_variasi_menu !== null  ?  '<p class="mb-0"><span class="text-muted">'+menu.nama_variasi_menu+'</span></p>' : '')+
      '</div>'+
      '<div class="text-right" style="width: 29%">'+addCommas(menu.total)+'</div>'+
      '<div class="text-center" style="width: 11%"><b style="font-size: 18px;padding: 5px 15px; border-radius:50%; line-height:1.3;" class="btnHapusListPesanan" data-index="'+menu.menu_id+'"><i class="fa fa-times text-danger"></i></b></div>'+
      '</div>'+
      '</li> ';
    });
  });
  await $('#list-pesanan').html(htmlListPesanan);
  await $('#pesananSubtotalText').html(addCommas(data.subtotal));
  await setKalkulasi();
}

async function setKalkulasi(){
  let _data = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
  let _total = await _data.subtotal;
  /// kalkulasi diskon
  if(_data.diskon_id !== 0){
    _data.total_diskon = await (parseFloat(_total) * parseFloat(_data.jumlah_diskon))/100;
    _total = await parseFloat(_total) - _data.total_diskon ;
    if(_data.tipe_diskon === 'persen')
      await $('#pesananDiskonLabel').html(_data.nama_diskon+' ('+_data.jumlah_diskon+'%)');
    else
      await $('#pesananDiskonLabel').html(_data.nama_diskon);
    await $('#pesananDiskonText').html(addCommas( parseInt(_data.total_diskon) ));
  }else{
    await $('#pesananDiskonLabel').html('Diskon');
    await $('#pesananDiskonText').html('0');
  }
  /// kalkulasi biaya tambahan 
  if(_data.biaya_tambahan_id !== 0){
    _data.total_biaya_tambahan = await (parseFloat(_total) * parseFloat(_data.jumlah_biaya_tambahan))/100;
    _total = await parseFloat(_total) + _data.total_biaya_tambahan ;
    await $('#pesananBiayaTambahanLabel').html(_data.nama_biaya_tambahan+' ('+_data.jumlah_biaya_tambahan+'%)');
    await $('#pesananBiayaTambahanText').html(addCommas( parseInt(_data.total_biaya_tambahan) ));
  }else{
    await $('#pesananBiayaTambahanLabel').html('Biaya Tambahan');
    await $('#pesananBiayaTambahanText').html('0');
  }
  
  if(_data.pajak_id !== 0){
    _data.total_pajak = await (parseFloat(_total) * parseFloat(_data.jumlah_pajak))/100;
    _total = await parseFloat(_total) + _data.total_pajak ;
    await $('#pesananPajakLabel').html(_data.nama_pajak+' ('+_data.jumlah_pajak+'%)');
    await $('#pesananPajakText').html(addCommas( parseInt(_data.total_pajak) ));
  }else{
    await $('#pesananPajakLabel').html('Pajak');
    await $('#pesananPajakText').html(0);
  } 
  _data.total = parseInt(_total);
  await $('#pesananTotalBayarText').html(addCommas(_data.total));
  await localStorage.setItem('pesanan_terfokus', JSON.stringify(_data));
}


  /// WARNING!!!!  FUNGSI INI MASIH SEMENTARA 
  async function setNomorPesanan(data=[], returnData = false){
    let noUrutPesanan = await JSON.parse(localStorage.getItem('no_urut_pesanan'));
    const user = await JSON.parse(localStorage.getItem('user'));

    kodePesanan = await noUrutPesanan+''+user.id+''+zeroFill(Math.floor((Math.random() * 100000) + 1), 5);

    if(returnData === false){
      let data = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
      data.no_pemesanan = await zeroFill(parseInt(noUrutPesanan),3);
      data.kode_pemesanan = await kodePesanan;
    }

    let tanggal = await datetimeEvent();
    
    // await android.setNomorPesanan(tanggal.tanggal, noUrutPesanan); 


    if(returnData === false){
      await localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
    }else{
      return {
        'no_pemesanan' : user.no_urut + '-' +zeroFill(noUrutPesanan,4),
        'kode_pemesanan' : kodePesanan,
      };
    }
  }

  $('body').on('click','.btnHapusListPesanan',async function(){
      let data = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
      let dataIndex = $(this).attr('data-index');
      let pesananIndex = data.pesanan.findIndex(v => v.menu_id === dataIndex);
      await data.pesanan.splice(pesananIndex,1);
      await localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
      await setListPesanan();
  });

  async function incNomorPesanan(){
    let noUrutPesanan = await JSON.parse(localStorage.getItem('no_urut_pesanan'));
    noUrutPesanan =  await parseInt(noUrutPesanan) + 1;
    await localStorage.setItem('no_urut_pesanan', JSON.stringify(noUrutPesanan));
    let _tanggal = await datetimeEvent();
    android.setNomorPesanan(_tanggal.tanggal, noUrutPesanan);
  }
// daftar pesanan
function resetHTMLListPesanan(){
  $('#list-pesanan').html("<div class=\"text-center mt-2 \"> <p><img width=\"180px\" src=\"gambar/empty-list.png\" class=\"img-responsive\" /></p><p><label>Tidak Ada Pesanan</label></p> </div>");
}

function setBlankListPesanan(){
 $('#list-pesanan').html('');
}




function resetHTMLKalkulasiPesanan(){
 $('#namaPelanggan').html('Pelanggan');
 $('#namaMeja').html('Tanpa Meja');
 $('#pesananSubtotalText').html(0);
 $('#pesananDiskonLabel').html('Diskon');
 $('#pesananDiskonText').html(0);
 $('#pesananBiayaTambahanLabel').html('Biaya Tambahan');
 $('#pesananBiayaTambahanText').html(0);
 $('#pesananPajakLabel').html('Pajak');
 $('#pesananPajakText').html(0);
 $('#pesananTotalBayarText').html(0);
}

function resetStoragePesananTerfokus(){
 let pesananTerfokusSet = { 

   tanggal_simpan: "",
   waktu_simpan: "",

   tanggal_proses: "",
   waktu_proses: "",

   no_pemesanan: "-",
   kode_pemesanan: '',

   pesanan : [],
   total_item : 0,

   pelanggan_id : 0,
   nama_pelanggan : '',

   kategori_meja_id : 0, 
   nama_kategori_meja : '', 
   meja_id : 0,
   nama_meja : '',

   diskon_id : 0,
   nama_diskon : '',
   jumlah_diskon : 0,
   total_diskon : 0,

   biaya_tambahan_id : 0,
   nama_biaya_tambahan : '',
   jumlah_biaya_tambahan : 0,
   total_biaya_tambahan : 0,

   pajak_id : 0,
   nama_pajak : '',
   jumlah_pajak : 0,
   total_pajak : 0,

   subtotal : 0,
   total : 0,
   catatan : ''

 }
 localStorage.setItem('pesanan_terfokus', JSON.stringify(pesananTerfokusSet));
}
/********** KATEGORI MEJA*********/
async function pencarianMeja(){
  
  let dataMeja = await JSON.parse(localStorage.getItem('meja'));
  dataMeja = await dataMeja.filter(v => v.kategori_meja_id === _state.kategoriMejaTerpilih);
  await setHTMLMeja(dataMeja, true);
}

function setHTMLKategoriMeja(){
  let data = JSON.parse(localStorage.getItem('kategori_meja'));
  let htmlList = "";
  for (var i = 0; i < data.length; i++) {
    htmlList = htmlList + '<li class="'+(i === 0 ? 'mui--is-active':'mui')+' opsi-kategori-meja" data-index="'+data[i].id_kategori_meja+'">'+
      '<a>'+ data[i].nama_kategori_meja +'</a>'+
    '</li>';
  }
  htmlList = htmlList + '<li class="mui opsi-kategori-meja" data-index="0">'+
      '<a>Tanpa Kategori</a>'+
    '</li>';

  $('#listKategoriMeja').html(htmlList);
}
function setStorageKategoriMejaTerpilih(){
 let data = JSON.parse(localStorage.getItem('data'));
 data.kategori_meja_terpilih = _state.kategoriMejaTerpilih;
 localStorage.setItem('data', JSON.stringify(data));
}

$('body').on('click','.opsi-kategori-meja', async function(){
 _state.kategoriMejaTerpilih = await parseInt($(this).attr('data-index'));
 $('.opsi-kategori-meja').removeClass("mui--is-active");
 $(this).addClass("mui--is-active");
  pencarianMeja();
 // kategori_meja_id
 setStorageKategoriMejaTerpilih(); //hanya proses simpan 
});
/********** MEJA *********/
function setHTMLMeja(data = [], filtered = false){
  if(filtered === false)
    data = JSON.parse(localStorage.getItem('meja'));
  var htmlList ="";
  if(data.length === 0){
    htmlList = '<div class="text-center mt-2"><p><img src="gambar/empty-list.png" class="img-responsive" /></p><p><label>Data Tidak Tersedia</label></p> </div>';
  }else{

      htmlList = htmlList + '<div class="row mb-4">';
       htmlList = htmlList +  '<div class="col-lg-3 col-md-6 col-sm-6">'+
        '<div class="card meja mb-4 opsi-meja" data-index="0">'+
          '<div class="card-body p-2" >'+
            '<div class="d-flex">'+
              '<div style="height: 60px; width: 60px; min-width: 60px; background: #fff; border-radius: 15px; position:relative;">'+
                '<h3 class="m-0 text-center w-100"><i class="fa fa-times" style="color:#ff4c4c"></i></h3>'+
              '</div>'+
              '<div class="text-left pl-3 py-1">'+
                '<label class="mb-1 w-100 font-weight-bold" style="font-size:14px;line-height: 1.2;">Tanpa Meja</label>'+
                '<label class="" style="line-height: 1.2;"></label>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
      '</div>';

    let jumlahTerpotong = (data.length+1)%5;
    let jumlahTidakTerpotong = (data.length+1)-jumlahTerpotong;
    for (var i = 0; i < data.length; i++) {
      // if(i%5 == 0)
      // if( ) 
      htmlList = htmlList +  '<div class="col-lg-3 col-md-6 col-sm-6">'+
        '<div class="card meja mb-4 opsi-meja" data-index="'+ data[i].id_meja +'" >'+
          '<div class="card-body p-2" >'+
            '<div class="d-flex">'+
              '<div style="height: 60px; width: 60px; min-width: 60px; background: #fff; border-radius: 15px;">'+
                '<h3 class="m-0">'+data[i].nama_meja+'</h3>'+
              '</div>'+
              '<div class="text-left pl-3 py-1">'+
                '<label class="mb-1 w-100 font-weight-bold" style="font-size:14px;line-height: 1.2;">'+ucfirst(data[i].bentuk)+'</label>'+
                '<label class="" style="line-height: 1.2;">'+data[i].pax+' Pax</label>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
      '</div>';
    }
    htmlList = htmlList + '</div>';
  }
  $('#listMeja').html(htmlList);
}

function setStorageMejaTerpilih(){
  let dataMeja = JSON.parse(localStorage.getItem('meja'));
  let dataKategoriMeja = JSON.parse(localStorage.getItem('kategori_meja'));
  let data = JSON.parse(localStorage.getItem('pesanan_terfokus'));

  if(_state.mejaTerpilih > 0){
    $.each( dataMeja, function( k, m ) {
      if(parseInt(_state.mejaTerpilih) === parseInt(m.id_meja)){
        data.meja_id = m.id_meja;
        data.nama_meja = m.nama_meja;
        let kategoriMeja = dataKategoriMeja.find(v => v.id_kategori_meja === m.kategori_meja_id);
        if(kategoriMeja){
          data.kategori_meja_id = m.kategori_meja_id;
          data.nama_kategori_meja = kategoriMeja.nama_kategori_meja;
          $('#namaMeja').html(m.nama_meja + (kategoriMeja.nama_kategori_meja !== undefined ? ' - '+ kategoriMeja.nama_kategori_meja:"") );
        }else{
          data.kategori_meja_id = 0;
          data.nama_kategori_meja = 'Tanpa Kategori';
          $('#namaMeja').html(m.nama_meja);
        }
      }
    });
  }else {
    data.meja_id = 0;
    data.nama_meja = "";
    data.kategori_meja_id = 0;
    data.nama_kategori_meja = "";
    $('#namaMeja').html('Tanpa Meja');
  }
  localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
}

$('body').on('click','.opsi-meja',function(){
  _state.mejaTerpilih = $(this).attr('data-index');
  $('.opsi-meja').removeClass("meja-option-active");
  $(this).addClass("meja-option-active");

  setStorageMejaTerpilih();

  $('#modalpilihmeja').modal('hide');
});

/*********** PELANGGAN ***********/
$('#pencarian_modal_pelanggan').on('keyup', async function(){
  let pencarian = await this.value;
  let _data = await JSON.parse(localStorage.getItem('pelanggan'));
  if(pencarian !== '' && pencarian !== null && pencarian.length >= 1 ){
    _data = await _data.filter(item => (
      ( item.nama_pelanggan ? (item.nama_pelanggan.toLowerCase()).indexOf(pencarian) > -1 : false ) ||
      (  item.email ? (item.email.toLowerCase()).indexOf(pencarian) > -1 : false  ) ||
      ( item.no_hp ? (item.no_hp.toLowerCase()).indexOf(pencarian) > -1 : false )
    ));
  }
  setHTMLPelanggan(_data);
});
$('#btnModalPelanggan').click(function(){
  setHTMLPelanggan();
  $('#modalpilihpelanggan').modal('show');
});
async function setHTMLPelanggan(data = null){
  await $('#btnModalKembaliPelanggan').hide();
  if(data === null)
    data = await JSON.parse(localStorage.getItem('pelanggan'));
  let htmlList = "";
  if(data.length === 0){
    htmlList = await "<div class=\"text-center mt-2\"> <img src=\"gambar/empty-list.png\" class=\"img-responsive\" /> </div>";
  }else{
    htmlList = await "<ul class=\"list-group rounded-0\">";

    htmlList += await '<li class="list-group-item opsi-pelanggan '+(_state.pelangganTerpilih === 0 ? "active" : '' )+'"  data-index="0">'+
        '<div class="row">'+
          '<div class="col-4">Tanpa Pelanggan</div>'+
          '<div class="col-4 text-center">-</div>'+
          '<div class="col-4 text-right">-</div>'+
        '</div>'+
        
    '</li>';
    for(let i=0; i < data.length; i++){
      htmlList += await '<li class="list-group-item opsi-pelanggan '+(data[i].id_pelanggan === _state.pelangganTerpilih ? "active" : '' )+'"  data-index='+data[i]['id_pelanggan']+'>'+
          '<div class="row">'+
            '<div class="col-4 text-truncate">'+(data[i]['nama_pelanggan'] ? data[i]['nama_pelanggan'] : '') +'</div>'+
            '<div class="col-4 text-center text-truncate">'+(data[i]['no_hp'] ? data[i]['no_hp'] : '-')+'</div>'+
            '<div class="col-4 text-right text-truncate">'+(data[i]['email'] ? data[i]['email'] :'-')+'</div>'+
          '</div>'+
          
      '</li>';
    }   
    htmlList += await "</ul>";
    await $('#pencarianModalPelanggan').show();
  }
  await $('#modalpilihpelanggantitle').html('Pelanggan');


  await $('#buttonModalSimpanPelanggan').hide();
  await $('#buttonModalTambahPelanggan').show();

  await $('#modalpilihpelangganbodyinput').hide();
  await $('#modalpilihpelangganbodylist').show();
  await $('#modalpilihpelangganbodylist').html(htmlList);
}

$('#btnModalKembaliPelanggan').click(function(){
 setHTMLPelanggan();
});

$('#buttonModalTambahPelanggan').click(function(){
 $(this).hide();
 $('#buttonModalSimpanPelanggan').show();
 $('#pencarianModalPelanggan').hide();
 $('#btnModalKembaliPelanggan').show(); //arrow back
 $('#modalpilihpelanggantitle').html('Tambah Pelanggan'); //title
 $('#modalpilihpelangganbodyinput').show();
 $('#modalpilihpelangganbodylist').hide();
});

$('#buttonModalSimpanPelanggan').click(async function(){
  let nama = await $('input[name=nama_pelanggan]').val();
  let no_hp = await $('input[name=no_hp_pelanggan]').val();
  let email = await $('input[name=email_pelanggan]').val();

  

  let data = await {
    id_pelanggan : '-'+Math.floor(Math.random() * 26) + Date.now(),
    nama_pelanggan : $('input[name=nama_pelanggan]').val(),
    email : $('input[name=email_pelanggan]').val(),
    no_hp : $('input[name=no_hp_pelanggan]').val(),
  };
  let pelanggan = await JSON.parse(localStorage.getItem('pelanggan'));
  await pelanggan.push(data);
  await localStorage.setItem('pelanggan', JSON.stringify(pelanggan));
  sinkronisasiDataPelanggan();
  await $('input[name=nama_pelanggan]').val('');
  await $('input[name=no_hp_pelanggan]').val('');
  await $('input[name=email_pelanggan]').val('');
});


function setStoragePelangganTerpilih(){
 let dataPelanggan = JSON.parse(localStorage.getItem('pelanggan'));
 let data = JSON.parse(localStorage.getItem('pesanan_terfokus'));

 let pelanggan = dataPelanggan.find(p => parseInt(p.id_pelanggan) === _state.pelangganTerpilih);

  if(pelanggan){
    data.pelanggan_id = pelanggan.id_pelanggan;
    data.nama_pelanggan = pelanggan.nama_pelanggan;
  }else{
    data.pelanggan_id = 0;
    data.nama_pelanggan = "Tanpa Pelanggan";
  }

 localStorage.setItem('pesanan_terfokus', JSON.stringify(data));

 $('#namaPelanggan').html(data.nama_pelanggan);
}

$('body').on('click','.opsi-pelanggan', function(){
 _state.pelangganTerpilih = parseInt($(this).attr('data-index'));

 $('.opsi-pelanggan').removeClass("active");
 $(this).addClass("active");

 setStoragePelangganTerpilih();
 $('#modalpilihpelanggan').modal('hide');
});


/*********** DISKON ***********/
function setHTMLDiskon(data = null){
  if(data === null)
    data = JSON.parse(localStorage.getItem('diskon'));
  let htmlList = "";
  if(data.length === 0){
    htmlList = "<div class=\"text-center mt-2 \"> <p><img width=\"180px\" src=\"gambar/empty-list.png\" class=\"img-responsive\" /></p><p><label>Data Tidak Tersedia</label></p> </div>"
  }else{
    htmlList = "<ul class=\"list-group rounded-0\">";
    htmlList += "<li class=\"list-group-item d-flex px-4 font-weight-bold opsi-diskon "+(_state.diskonTerpilih === 0 ? 'active' : '' )+" \"  data-index=\"0\">"+
        "<div class=\"flex-fill\">Tanpa Diskon</div>"+
        "<div style=\"width:20%\" class=\"text-right\">0%</div>"+
        "</li>";
    for(let i=0; i < data.length; i++){
      htmlList += "<li class=\"list-group-item d-flex px-4 font-weight-bold opsi-diskon "+(data[i].id_diskon === _state.diskonTerpilih ? 'active' : '' )+" \"  data-index="+data[i]['id_diskon']+">"+
        "<div class=\"flex-fill\">"+data[i]['nama_diskon']+"</div>"+
        "<div style=\"width:20%\" class=\"text-right\">"+(data[i]['tipe_diskon'] === 'persen' ? data[i]['jumlah']+'%': 'Rp'+data[i]['jumlah'])+"</div>"+
        "</li>";
    }   
    htmlList += "</ul>";
  }
  $('#modalpilihdiskonbody').html(htmlList);
}


function setStorageDiskonTerpilih(){
  let dataDiskon = JSON.parse(localStorage.getItem('diskon'));
  let data = JSON.parse(localStorage.getItem('pesanan_terfokus'));

  if(_state.diskonTerpilih > 0){

    let diskonFiltered = dataDiskon.filter(d => parseInt(d.id_diskon) === parseInt(_state.diskonTerpilih));
    if(diskonFiltered.length > 0){
      let diskon = dataDiskon.find(d => parseInt(d.id_diskon) === parseInt(_state.diskonTerpilih));
      data.diskon_id = diskon.id_diskon;
      data.nama_diskon = diskon.nama_diskon;
      data.tipe_diskon = diskon.tipe_diskon;
      data.jumlah_diskon = diskon.jumlah;
    }
  }else{
    data.diskon_id = 0;
    data.nama_diskon = "";
    data.tipe_diskon = "";
    data.jumlah_diskon = 0;
  }

 localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
}

$('body').on('click','.opsi-diskon',function(){
 _state.diskonTerpilih = parseInt($(this).attr('data-index'));
 $('.opsi-diskon').removeClass("active");
 $(this).addClass("active");
});

$('body').on('click','#buttonModalPilihDiskon', async function(){
 await setStorageDiskonTerpilih();
 $('#modalpilihdiskon').modal('hide');
 setKalkulasi();
});

/*************** BIAYA TAMBAHAN ***************/
function setHTMLBiayaTambahan(data = null){
  if(data === null)
    data = JSON.parse(localStorage.getItem('biaya_tambahan'));

  let htmlList = "";
  if(data.length > 0){
    htmlList = "<ul class=\"list-group rounded-0\">";
    htmlList += "<li class=\"list-group-item font-weight-bold opsi-biaya-tambahan "+(_state.biayaTambahanTerpilih === 0 ? 'active' : '' )+" \"  data-index=\"0\">Tanpa Biaya Tambahan<span class=\"float-right\">0%</span></li>";
    for(let i=0; i < data.length; i++){
      htmlList += "<li class=\"list-group-item font-weight-bold opsi-biaya-tambahan "+(data[i].id_biaya_tambahan === _state.biayaTambahanTerpilih ? 'active' : '' )+" \"  data-index="+data[i]['id_biaya_tambahan']+">"+data[i]['nama_biaya_tambahan']+"<span class=\"float-right\">"+data[i]['jumlah']+"%</span></li>";
    }   
    htmlList += "</ul>";
  } else{
    htmlList =
    '<div class="text-center mt-2 "> <p><img width="180px" src="gambar/empty-list.png" class="img-responsive"></p><p><label>Data Tidak Tersedia</label></p> </div>'
 }
 $('#modalpilihbiayatambahanbody').html(htmlList);
}

function setStorageBiayaTambahanTerpilih(){
 let dataBiayaTambahan = JSON.parse(localStorage.getItem('biaya_tambahan'));
 let data = JSON.parse(localStorage.getItem('pesanan_terfokus'));

  if(_state.biayaTambahanTerpilih > 0){

    let biayaTambahanFiltered = dataBiayaTambahan.filter(d => parseInt(d.id_biaya_tambahan) === parseInt(_state.biayaTambahanTerpilih));
    if(biayaTambahanFiltered.length > 0){
      let biayaTambahan = dataBiayaTambahan.find(d => parseInt(d.id_biaya_tambahan) === parseInt(_state.biayaTambahanTerpilih));
      data.biaya_tambahan_id = biayaTambahan.id_biaya_tambahan;
      data.nama_biaya_tambahan = biayaTambahan.nama_biaya_tambahan;
      data.jumlah_biaya_tambahan = parseFloat(biayaTambahan.jumlah);
    }
  }else{
    data.biaya_tambahan_id = 0;
    data.nama_biaya_tambahan = "";
    data.jumlah_biaya_tambahan = 0;
  }

 localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
}

$('body').on('click','.opsi-biaya-tambahan',function(){
  _state.biayaTambahanTerpilih = parseInt($(this).attr('data-index'));
  $('.opsi-biaya-tambahan').removeClass("active");
  $(this).addClass("active");
});

$('body').on('click','#buttonModalPilihBiayaTambahan', async function(){
  await setStorageBiayaTambahanTerpilih();
  $('#modalpilihbiayatambahan').modal('hide');
  setKalkulasi();
});


/************************************ TOMBOL SIMPAN PESANAN ************************/
$('body').on('click','#btnSimpanPesanan',  async function(){
 let data = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
 let pesanan = await JSON.parse(localStorage.getItem('pesanan'));
 let jumlahPesananTerdeteksi = await (pesanan.filter(p => p.kode_pemesanan === data.kode_pemesanan)).length;
 if(data.pesanan.length > 0){
   if(jumlahPesananTerdeteksi === 0){
     let dateTime = datetimeEvent();
     data.tanggal_simpan = dateTime.tanggal;
     data.waktu_simpan = dateTime.waktu;
     pesanan.push(data);
   }else if(jumlahPesananTerdeteksi > 0){
     let pesananIndex = pesanan.findIndex(p => p.kode_pemesanan === data.kode_pemesanan);
     data.is_uploaded = 0;
     pesanan[pesananIndex] = data;
   }
   incNomorPesanan();
   localStorage.setItem('pesanan', JSON.stringify(pesanan));
   setDefaultPesanan();
   sinkronisasiDataPesanan();
   $('#modalinformasipesanandisimpan').modal('show');
 }else{
   android.CustomToast('Tidak Ada Pesanan');
 }
});
$('body').on('click','#opsipilihhapuspesanan',function(){
 $('#modalkonfirmasihapuspesanantersimpan').modal('show');
});




/************************** PEMBAYARAN ******************/
var dataCoba = [];
var totalPembayaran = 0;
var nominalPembayaran = 0;
var kembalianPembayaran = -1;
$('body').on('click','#btnBayarPesanan', async function(){
  let detail = await JSON.parse(localStorage.getItem('pesanan_terfokus'));
  let daftarPesanan = await JSON.parse(localStorage.getItem('pesanan'));

  let jumlahPesananTerdeteksi = (daftarPesanan.filter(p => p.kode_pemesanan === detail.kode_pemesanan)).length;
  let dateTime = datetimeEvent();
  detail.tanggal_simpan = dateTime.tanggal;
  detail.waktu_simpan = dateTime.waktu;
  detail.is_uploaded = 0;
  await localStorage.setItem('pesanan_terfokus', JSON.stringify(detail));

  if(detail.pesanan.length > 0){
    if(jumlahPesananTerdeteksi === 0){
      daftarPesanan.push(detail);
    }else if(jumlahPesananTerdeteksi > 0){
      let pesananIndex = daftarPesanan.findIndex(p => p.kode_pemesanan === detail.kode_pemesanan);
      daftarPesanan[pesananIndex] = detail;
    }

    await localStorage.setItem('pesanan', JSON.stringify(daftarPesanan));

    /// mengambil data jenis pemesanan 
    let jenisPemesanan = await JSON.parse(localStorage.getItem('jenis_pemesanan'));
    /// mengecek apakah data jenis pemesanan kosong
    if(jenisPemesanan.length === 0) jenisPemesanan = await [{id_tipe_penjualan: 0, nama_tipe_penjualan: ''}];
    /// menyusun pesanan sesuai jenis pesanan masing2 menu
    let pesanan = await [];
    for(let i = 0; i < jenisPemesanan.length; i++){
      pesanan[i] = await {
        id_tipe_penjualan: jenisPemesanan[i].id_tipe_penjualan,
        nama_tipe_penjualan: jenisPemesanan[i].nama_tipe_penjualan,
        menu: [],
      };
      for(let a = 0; a < detail.pesanan.length; a++){
        if(pesanan[i].id_tipe_penjualan === detail.pesanan[a].tipe_penjualan_id){
          await pesanan[i].menu.push(detail.pesanan[a]);
        }
      }
    }
    let htmlListPesanan = '';
    $.each(pesanan, function( key, m ) {
      if(m.id_tipe_penjualan !== 0 && m.menu.length >= 1)
      htmlListPesanan = htmlListPesanan + '<li class="list-group-item border-0 py-1 text-center" data-index="'+ m.id_tipe_penjualan +'">-'+ m.nama_tipe_penjualan +'-</li>';
      $.each( m.menu, function( k, menu) {
        htmlListPesanan = htmlListPesanan + '<li class="list-group-item border-0 px-3 pt-1 pb-2" data-index="'+ menu.menu_id +'">'+
        '<div class="d-flex">'+
        '<div class="text-left" style="width: 15%;"><b class="badge-pesanan">'+menu.jumlah+'</b></div>'+
        '<div class="pr-1 flex-grow-1 text-left" style="width: 47%">'+
        '<div class="text-truncate font-weight-bold">'+menu.nama_menu+'</div>'+
        (menu.nama_variasi_menu  ?  '<span class="text-muted">'+menu.nama_variasi_menu+'</span><br/>' : '')+
        '</div>'+
        '<div class="text-right" style="width: 30%">'+addCommas(menu.total)+'</div>'+
        '</div>'+
        '</li> ';
      });
    });
    $('#listPesananPembayaran').html(htmlListPesanan);

    $('#noPemesananPembayaran').html('#'+detail.no_pemesanan);
    $('#mejaPembayaran').html(detail.nama_meja);
    $('#subtotalPembayaran').html(addCommas(detail.subtotal));
    $('#diskonTotalPembayaran').html(addCommas(detail.total_diskon));
    $('#biayaTambahanTotalPembayaran').html(addCommas(detail.total_biaya_tambahan));
    $('#pajakTotalPembayaran').html(addCommas(detail.total_pajak));
    $('#totalPembayaran').html('Rp '+addCommas(detail.total));
    $('#uangpasPembayaran').attr('data-value',detail.total);
    $('#jumlahTunaiPembayaran').val('');

    $('#modalpembayaran').modal('show');
  }else{
    android.CustomToast('Daftar pesanan tidak boleh kosong');
  }
});
///// PROSES NOMINAL PEMBAYARAN

$('.opsi-nominal-pembayaran').click(function(){
  let val = parseInt($(this).attr('data-value'));
  let reset = parseInt($(this).attr('data-reset'));
  if(reset === 0 ){
    if(_state.resetNominalPembayaran === 1)
      _state.nominalPembayaran  = val;
    else
      _state.nominalPembayaran  = _state.nominalPembayaran + val;
  }else{
    _state.nominalPembayaran  = val;
  }
  
  _state.resetNominalPembayaran  = reset;
  $('#jumlahTunaiPembayaran').val(_state.nominalPembayaran);
});


$('#clearButtonNominalPembayaran').click(function(){
  _state.nominalPembayaran = 0;
  $('#jumlahTunaiPembayaran').val('');
});

/******************* PROSES BAYAR **********************/
_statePembayaran = {};
$('body').on('click','#btnBayarPembayaran', async function(){
  let detail = JSON.parse(localStorage.getItem('pesanan_terfokus'));
  _statePembayaran = detail;
  if(_state.nominalPembayaran >= parseInt(detail.total) ){
    $('#modalpembayaran').modal('hide');
    $('#modaltransaksiselesai').modal('show');
    let dateTime = datetimeEvent();
    detail.status = 'sukses';
    detail.is_uploaded = 0;
    detail.tanggal_proses = dateTime.tanggal;
    detail.waktu_proses = dateTime.waktu;
    detail.tunai = _state.nominalPembayaran;
    detail.kembalian = _state.nominalPembayaran - parseInt(detail.total);
    if(deleteDataPesanan(detail.kode_pemesanan)){
      incNomorPesanan();
      $('#kembalianSelesaiPembayaran').html('Rp ' + addCommas(detail.kembalian));
      await addDataRiwayat(detail);
      await resetStoragePesananTerfokus();
      await setDefaultPesanan();
    }
    await setHTMLPesananTersimpan();
    await setHTMLRiwayat();
    await sinkronisasiDataRiwayat();
    _state.nominalPembayaran = 0;
  }else{
    android.CustomToast('Nominal pembayaran kurang dari jumlah tagihan');
  }
});

function resetHTMLModalPembayaran(){
 $('#nominalPembayaran').val('');
 $('#kembalianPembayaran').html('');
}


async function setDefaultPesanan(){
 await resetStoragePesananTerfokus();
 $('#kode_pemesanan').html('Pesanan');
 $('#namaPelanggan').html('Pelanggan');
 $('#namaMeja').html('Tanpa Meja');

 await resetHTMLKalkulasiPesanan();
 await resetHTMLListPesanan();
 await resetHTMLModalPembayaran();
 return true;
}


/******************  SELESAI PEMBAYARAN ************************/

$('body').on('click','#btnPrintNotaSelesaiPembayaran', function(){
  let _outlet = JSON.parse(localStorage.getItem('outlet_terpilih'));
  let _user = JSON.parse(localStorage.getItem('user'));
  let _perangkat = JSON.parse(localStorage.getItem('perangkat'));
  let _dataPesanan = [];
  for(let i = 0; i < _statePembayaran.pesanan.length; i++){
    let jumlahSama = 0;
    for(let a = 0; a < _dataPesanan.length; a++){
      if(_dataPesanan[a].nama_tipe_penjualan === _statePembayaran.pesanan[i].nama_tipe_penjualan){
        jumlahSama++;
      }
    }
    if(jumlahSama === 0){
      _dataPesanan.push({'nama_tipe_penjualan': _statePembayaran.pesanan[i].nama_tipe_penjualan, 'menu':[] });
    }

    for(let a = 0; a < _dataPesanan.length; a++){
      if(_dataPesanan[a].nama_tipe_penjualan === _statePembayaran.pesanan[i].nama_tipe_penjualan){
        _dataPesanan[a].menu.push(
          {
              "harga": ( _statePembayaran.pesanan[i].harga ? 'Rp '+addCommas(_statePembayaran.pesanan[i].harga) : ""), 
              "jumlah": ( _statePembayaran.pesanan[i].jumlah ? _statePembayaran.pesanan[i].jumlah : ""), 
              "nama_variasi_menu": ( _statePembayaran.pesanan[i].nama_variasi_menu ? _statePembayaran.pesanan[i].nama_variasi_menu : ""), 
              "nama_tipe_penjualan": ( _statePembayaran.pesanan[i].nama_tipe_penjualan ? _statePembayaran.pesanan[i].nama_tipe_penjualan : "" ), 
              "nama_menu": ( _statePembayaran.pesanan[i].nama_menu ? _statePembayaran.pesanan[i].nama_menu : ""), 
              "total": ( _statePembayaran.pesanan[i].total ? 'Rp'+addCommas(_statePembayaran.pesanan[i].total) : "")
          }
        );
      }
    }
  }
  var dataPesanan = {
    "url_logo": _outlet.url_logo, 
    "nama_outlet": _outlet.nama_outlet, 
    "alamat": (_outlet.alamat ? _outlet.alamat : "") , 
    "telpon": (_outlet.telpon ? _outlet.telpon : ""), 
    "nama_user": (_user.nama ? _user.nama : ""), 
    "nama_pelayan": "", 
    "kode_pemesanan": (_statePembayaran.kode_pemesanan ? _statePembayaran.kode_pemesanan : ""), 
    "no_pemesanan": ( _statePembayaran.no_pemesanan ? _statePembayaran.no_pemesanan : ""), 
    "waktu_proses": ( _statePembayaran.waktu_proses ? _statePembayaran.waktu_proses : ""), 
    "tanggal_proses": ( _statePembayaran.tanggal_proses ? _statePembayaran.tanggal_proses : ""),

    "pesanan": _dataPesanan, 
    "subtotal": (_statePembayaran.subtotal ? "Rp "+addCommas(_statePembayaran.subtotal) :"Rp 0"), 
    //diskon
    "nama_diskon": (_statePembayaran.nama_diskon ? _statePembayaran.nama_diskon : ""), 
    "jumlah_diskon": (_statePembayaran.jumlah_diskon ? _statePembayaran.jumlah_diskon+"%":""),
    "total_diskon": ( _statePembayaran.total_diskon ? "Rp "+addCommas(_statePembayaran.total_diskon) : "Rp 0"), 
    
    //biaya tambahan
    "nama_biaya_tambahan": (_statePembayaran.nama_biaya_tambahan ? _statePembayaran.nama_biaya_tambahan : ""), 
    "jumlah_biaya_tambahan": ( _statePembayaran.jumlah_biaya_tambahan ? _statePembayaran.jumlah_biaya_tambahan + '%' : ""), 
    "total_biaya_tambahan": (_statePembayaran.total_biaya_tambahan ?  "Rp "+addCommas(_statePembayaran.total_biaya_tambahan) : "Rp 0"),
    
    //pajak
    "nama_pajak": (_statePembayaran.nama_pajak ? _statePembayaran.nama_pajak : ""), 
    "jumlah_pajak": (_statePembayaran.jumlah_pajak ? _statePembayaran.jumlah_pajak + '%' : "-"),
    "total_pajak": (_statePembayaran.total_pajak ? "Rp "+addCommas(_statePembayaran.total_pajak):"Rp 0"),

    "total": ( _statePembayaran.total ? "Rp "+addCommas(_statePembayaran.total) :"Rp 0"), 
    "tunai": (_statePembayaran.tunai ? "Rp "+addCommas(_statePembayaran.tunai):"Rp 0"), 
    "kembalian": (_statePembayaran.kembalian ? "Rp "+addCommas(_statePembayaran.kembalian) : "Rp 0"), 

    "catatan": (_outlet.catatan ? _outlet.catatan : "TERIMA KASIH"),
    //-----------------------
    "website": (_outlet.website ? _outlet.website : ""), 
    "facebook": (_outlet.facebook ? _outlet.facebook : ""), 
    "instagram": (_outlet.instagram ? _outlet.instagram : ""),
    "twitter": (_outlet.twitter ? _outlet.twitter : "")
  };
  resetHTMLModalSelesaiPembayaran(); 
  android.CustomToast(_perangkat.mac_printer_kasir);
  setTimeout(function(){ android.printPesanan(JSON.stringify(dataPesanan), _perangkat.mac_printer_kasir); }, 200);
});

$('body').on('click','#btnKembaliSelesaiPembayaran', function(){
 resetHTMLModalSelesaiPembayaran();
});

function resetHTMLModalSelesaiPembayaran(){
 $('#kembalianSelesaiPembayaran').html('');
 $('#inputKirimEmailStukTransaksi').val('');
 _statePembayaran = {};
 $('#modaltransaksiselesai').modal('hide');
}

$('#btnKirimEmailStukTransaksi').click(function(){
  if(IsEmail($('#inputKirimEmailStukTransaksi').val()) === false){
    android.CustomToast('Email yang dimasukkan salah');
    return false;
  }
  kirimEmailStruk(_statePembayaran);
  
});
/*
|------------------------------------------------------------------------------------------------------
|                  PROSES HALAMAN PESANAN TERSIMPAN
|------------------------------------------------------------------------------------------------------
|
|  1. fungsi pencarian         => mencari melalui storage
|  2. fungsi setHTMLPesananTersimpan   => menampilkan data pesanan tersimpan dari storage
|                    => mengurutkan berdasarkan no_pemesanan secara ASC
|  3. fungsi setDetailPesanan      => menampilkan detail pesanan dengan pesanan_tersimpan_terfokus di storage
|  4. fungsi setBatalPesanan       => membatalkan pesanan secara langsung ke storage  
|                    => mengupdate data pesanan batal ke server
|                    => memindahkan data pesanan ke riwayat dengan status batal
|  5. fungsi setLanjutPesanan      => menampilkan detail data ke pesanan terfokus 
|  catatan : perlu dibuatkan sinkronisasi dengan alur
|      .ketika pertama kali klik menu akan load data dari server sebelum menampilkan dari menu. namum apaliba terjadi delay lebih dari 10 detik
|      .apabila lebih dari 10 detik maka dianggap gagal dan kembali load dari storage. atau apabila sedang offline maka langsung load dari storage
|      .sediakan storage khusus atau variable khusus untuk di set sebagai parameter koneksi
|      . apa bila gagal load data maka action sinkronisasi ulang akan diberikan notifikasi untuk dapat dikonfirmasi reload atau tidak.
|  
*/

function gambarOnErrorPesanan(data){
  $('.gambar-pesanan[data-index='+data.getAttribute('data-index')+']').hide();
  setTimeout(function(){ 
    $('.inisial-pesanan[data-index='+data.getAttribute('data-index')+']').show();
  }, 50);
}

$('#pencarianPesananTersimpan').keyup(function(){
  let text = $(this).val();
  let list = [];
  if(text !== '' && text !== null && text.length >= 1 ){
    list = _statePage.pesanan.filter(item => (
          ((item.kode_pemesanan.toString()).toLowerCase()).indexOf(text) > -1
    ) || ( 
          ((item.no_pemesanan.toString()).toLowerCase()).indexOf(text) > -1
        )
    );
    setHTMLPesananTersimpan(list);
  }else if(text === '' || text === null || text.length < 1){
    setHTMLPesananTersimpan(_statePage.pesanan);
  }
});
function setHTMLPesananTersimpan(dataPesanan = null){
  if(dataPesanan === null)
    dataPesanan = JSON.parse(localStorage.getItem('pesanan'));
 let htmlList = "";
 $.each( dataPesanan , function( kp, p ) {
   htmlList = htmlList + '<li class="list-group-item pl-0 pr-3 pt-3 pb-2 opsi-list-pesanan-tersimpan" data-index="'+p.kode_pemesanan+'">'+
   '<div class="d-flex">'+
   '<div class="flex-fill text-left" style="width: 14%">'+
   '<div>'+
   '<p class="h4 my-2 text-center" style="color:#bbb"><i class="fas fa-receipt"></i></p>'+
   '</div>'+
   '</div>'+
   '<div class="flex-fill text-left" style="width: 43%">'+
   '<div>'+
   '<p class="font-weight-bold mb-2">Rp '+ addCommas(p.total)+'</p>'+
   '</div>'+
   '<div>'+
   '<p class="mb-0 font-small">'+addCommas(p.total_item) +' item</p>'+
   '</div>'+
   '</div>'+
   '<div class="flex-fill text-right" style="width: 43%">'+
   '<div>'+
   '<p class="font-weight-bold mb-2">'+(p.waktu_simpan !== null && p.waktu_simpan !== undefined ? p.waktu_simpan.slice(0, 5) : '')+'</p>'+
   '</div>'+
   '<div>'+
   '<p class="mb-0 font-small">'+ (
    p.meja_id !== 0 && 
    p.kategori_meja_id !== 0  
    ?  p.nama_meja + (p.kategori_meja_id !== 0 ? '-'+ p.nama_kategori_meja :'') : ''
    ) +' </p>'+
   '</div>'+
                '<div>'+
                  '<p class="mb-0 font-small">#'+p.no_pemesanan+'</p>'+
                '</div>'+
                '</div>'+
                '</div>'+
                '</li>';
              });

 $('#list-pesanan-tersimpan').html(htmlList);
}

function setDetailPesananTersimpan(data){

  let htmlMenu = "";
    $.each( data.pesanan , function( k, v ) {
      htmlMenu = htmlMenu + '<li class="list-group-item px-3 py-2">'+
        '<div class="d-flex">'+
          '<div class="pl-1 pr-3" style="width: auto;height:auto">'+
            '<div class="card border-0 inisial-pesanan" data-index="'+k+'" style="display:none;">'+
              '<div data-index="2" class="bd-placeholder-img card-img-top bg-grey-low rounded" style="height:66px;width:70px;">'+
                '<h5>'+getInitials(v.nama_menu)+'</h5>'+
              '</div>'+
            '</div>'+
            '<img data-index="'+k+'" src="'+v.gambar+'" class="rounded-lg gambar-pesanan" style="height:66px;width:70px;"  onerror="gambarOnErrorPesanan(this)" />'+
          '</div>'+
          '<div class="pr-1 flex-grow-1 text-left" style="width: 30%">'+
            '<div class="text-truncate">'+
              '<p class="mb-0 font-weight-bold">'+ v.nama_menu +'</p>'+
              (jQuery.type( v.nama_variasi_menu ) === "string" ? '<p class="mb-0"><small>'+v.nama_variasi_menu+'</small></p>':'')+
              (jQuery.type( v.nama_tipe_penjualan ) === "string" ? '<p class="mb-0"><small>'+v.nama_tipe_penjualan.toUpperCase()+'</small></p>':'')+
              (jQuery.type( v.catatan ) === "string" && v.catatan !== null && v.catatan !== undefined ? '<p class="mb-0"><small>'+v.catatan+'</small></p>':'')+
            '</div>'+
          '</div>'+
        '<div class="px-1 text-center" style="width: 20%">'+ addCommas(v.harga) +'&nbsp;x'+ v.jumlah +'</div>'+
          '<div class="text-right" style="width: 35%">'+
            addCommas(v.total) +
          '</div>'+
        '</div>'+
      '</li>';
    });

    let htmlPagePesananTersimpan = 
      '<div style="background: #f4f4f4; width: 100%; vertical-align: middle;z-index: 2;border-bottom: 1px solid #eee; " class="p-3">'+
        '<div class="d-flex mb-1">'+
          '<div class="flex-fill text-left" style="width: 50%">'+
            '<p class="font-weight-bold h4 mb-1">'+
              '#<span id="kodePesananTersimpan">'+zeroFill(data.no_pemesanan)+'</span>'+
            '</p>'+
          '</div>'+
          '<div class="flex-fill text-right" style="width: 50%">'+
            '<p class="font-weight-bold h4 mb-1 ">Rp '+addCommas(data.total)+'</p>'+
          '</div>'+
        '</div>'+
        '<div class="d-flex">'+
          '<div class="flex-fill text-left" style="width: 50%">'+
            '<p class="mb-1" >'+'Tanggal : ' + data.tanggal_simpan + ' ' + data.waktu_simpan.slice(0, 5)+'</p>'+
            '<p class="mb-0" >'+(
            (data.nama_pelayan !== null && data.nama_pelayan !== undefined && data.nama_pelayan !== '') ? 
            ('Pelayan : ' + data.nama_pelayan) : '' )+
            '</p>'+
          '</div>'+
          '<div class="flex-fill text-right" style="width: 50%">'+
            '<p class="mb-1" >'+(
              (data.nama_pelanggan !== null && data.nama_pelanggan !== '' && data.nama_pelanggan !== undefined) ?
              ('Pelanggan : ' + data.nama_pelanggan) : '')+
            '</p>'+
            '<p class="mb-0" id="mejaPesananTersimpan"> '+(
              ( data.nama_meja !== '' && data.nama_meja !== null && data.nama_meja != undefined && data.nama_kategori_meja !== null && data.nama_kategori_meja != undefined && data.nama_kategori_meja !== '') ? ( data.nama_kategori_meja +' : '+ data.nama_meja ) : 'Meja : Tanpa Meja '
              )+
            '</p>'+
          '</div>'+
        '</div>'+
      '</div>'+
    '<div style="width: 100%;" class="p-0 hide-scroll ">'+
      '<ul class="list-group list-group-flush">'+
        htmlMenu +
      '</ul>'+
      '<div class="col-8 ml-auto my-2">'+
        '<ul class="list-group list-group-flush">'+
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0 font-weight-bold">Subtotal</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right font-weight-bold" style="width: 50%">'+
                addCommas(data.subtotal)+
              '</div>'+
            '</div>'+
          '</li>'+
          (data.diskon_id !== 0 ? '<li class="list-group-item px-3 py-2">'+
          '<div class="d-flex">'+
            '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
              '<div class="text-truncate">'+
                '<p class="mb-0">'+( data.nama_diskon !== null ? data.nama_diskon : 'Diskon' )+' ('+data.jumlah_diskon+'%)</p>'+
              '</div>'+
            '</div>'+
            '<div class="text-right" style="width: 50%">'+
              addCommas(data.total_diskon)+
            '</div>'+
          '</div>'+
        '</li>' : '')+

        (data.pajak_id !== 0 ? '<li class="list-group-item px-3 py-2">'+
          '<div class="d-flex">'+
            '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
              '<div class="text-truncate">'+
                '<p class="mb-0">'+( data.nama_pajak !== null ? data.nama_pajak : 'Pajak')+' ('+data.jumlah_pajak+'%)</p>'+
              '</div>'+
            '</div>'+
            '<div class="text-right" style="width: 50%">'+
              addCommas(data.total_pajak)+
            '</div>'+
          '</div>'+
        '</li>':'')+
        (data.biaya_tambahan_id !== 0 ?'<li class="list-group-item px-3 py-2">'+
          '<div class="d-flex">'+
            '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
              '<div class="text-truncate">'+
                '<p class="mb-0">'+( data.nama_biaya_tambahan !== null ? data.nama_biaya_tambahan : 'Service')+' ('+data.jumlah_biaya_tambahan+'%)</p>'+
              '</div>'+
            '</div>'+
            '<div class="text-right" style="width: 50%">'+
              addCommas(data.total_biaya_tambahan)+
            '</div>'+
          '</div>'+
        '</li>' : '')+
        '<li class="list-group-item px-3 py-2">'+
          '<div class="d-flex">'+
            '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
              '<div class="text-truncate font-weight-bold">'+
                '<p class="h3 mb-0">Total</p>'+
              '</div>'+
            '</div>'+
            '<div class="text-truncate font-weight-bold">'+
              '<p class="h3 mb-0">'+
                'Rp '+addCommas(data.total)+
              '</p>'+
            '</div>'+
          '</div>'+
        '</li>'+
      '</ul>'+
    '</div>'+
    '<div style=" position: fixed; right:inherit; bottom:0; background: #fff; height: 3.5rem; width: calc(65% - 4.5rem); " class="p-2 hide-scroll text-right border-left border-top">'+
        '<button  class="btn btn-danger px-3 rounded-lg mr-2" id="btnBatalPesananTersimpan"  data-index="'+data.kode_pemesanan+'">Batalkan</button>'+
        '<button  class="btn btn-info px-3 rounded-lg" id="btnLanjutPesananTersimpan" data-index="'+data.kode_pemesanan+'">Lanjutkan</button>'+
      '</div>'+
    '</div>';

  $('#detail-page-pesanan-tersimpan').html(htmlPagePesananTersimpan);
  $('#title-page-pesanan-tersimpan').html('#'+data.no_pemesanan);
}
function setEmptyDetailPesananTersimpan(){
  $('#title-page-pesanan-tersimpan').html('');
 let htmlPagePesananTersimpan = '<div style=" position: fixed; right:inherit; top:0; background: #fff; height: 100vH; width: inherit; vertical-align: middle;z-index: 2; border-left:1px solid #e4e4e4; overflow-y: auto" class="p-3">'+

 '</div>';
 $('#detail-page-pesanan-tersimpan').html(htmlPagePesananTersimpan);
}

$('body').on('click','.opsi-list-pesanan-tersimpan', function(){
  var dataIndex = $(this).attr('data-index');
  var dataPesanan = JSON.parse(localStorage.getItem('pesanan'));

  var data = dataPesanan.find( p => p.kode_pemesanan === dataIndex);
  setDetailPesananTersimpan(data);   
});


$('body').on('click','#btnLanjutPesananTersimpan', async function(){
  let dataIndex = await $(this).attr('data-index');
  let dataPesanan = await JSON.parse(localStorage.getItem('pesanan'));
  let data = await dataPesanan.find( p => p.kode_pemesanan === dataIndex);
  await localStorage.setItem('pesanan_terfokus', JSON.stringify(data));
  await page('kasir');
});

async function setReOpenPesananTerfokus(){
  await resetHTMLKalkulasiPesanan();
  await resetHTMLModalPembayaran();

  let pesanan = await JSON.parse(localStorage.getItem('pesanan_terfokus'));

  $('#kode_pemesanan').html(pesanan.no_pemesanan !== "-" ?  '#' +pesanan.no_pemesanan : 'Pesanan');
  if(pesanan.nama_pelanggan !== "" && pesanan.nama_pelanggan !== null && pesanan.nama_pelanggan !== undefined)
    $('#namaPelanggan').html(pesanan.nama_pelanggan);
  else
    $('#namaPelanggan').html("Pelanggan");

  if(pesanan.nama_meja !== "" && pesanan.nama_meja !== null && pesanan.nama_meja !== undefined && pesanan.nama_kategori_meja !== "" && pesanan.nama_kategori_meja !== null && pesanan.nama_kategori_meja !== undefined)
    $('#namaMeja').html(pesanan.nama_meja+(pesanan.kategori_meja_id ? " - "+pesanan.nama_kategori_meja : "") );
  else
    $('#namaMeja').html("Tanpa Meja");


  await setListPesanan();
  if(pesanan)
    if(pesanan.pesanan)
      if(pesanan.pesanan.length === 0 ) {
        await resetHTMLListPesanan();
        await $('#pesananDiskonLabel').html('Diskon');
        await $('#pesananDiskonText').html('0');

        await $('#pesananBiayaTambahanLabel').html('Biaya Tambahan');
        await $('#pesananBiayaTambahanText').html('0');

        await $('#pesananPajakLabel').html('Pajak');
        await $('#pesananPajakText').html(0);
        await $('#pesananTotalBayarText').html(0);
      }
}

$('body').on('click','#btnBatalPesananTersimpan', function(){
  let kode_pemesanan = $(this).attr('data-index');
  $('#btnModalHapusPesananTersimpan').attr('data-index',kode_pemesanan);
 $('#modalkonfirmasihapuspesanantersimpan').modal('show');
});

$('body').on('click','#btnModalHapusPesananTersimpan', async function(){
 /*
 | mengubah status data menjadi batal
 | 1. ambil data pesanan dan temukan index yg akan diubah 
 | 2. pesanan tersimpan terfokus akan dikirim ke storage riwayat
 | 3. data dari storage pesanan akan dihapus dengan menunjuk index terpilih
 | 5. update data pesanan
 | 6. reload data dari pesanan tersimpan
 | 7. sambil memperbaharui data riwayat dengan sinkronisasi riwayat
 */
 $('#modalkonfirmasihapuspesanantersimpan').modal('hide');

 var dataIndex = await $(this).attr('data-index');
  let detail = getDetailPesanan(dataIndex);
  if (detail){
    let dateTime = datetimeEvent();
    detail.is_uploaded = 0;
    detail.tanggal_proses = dateTime.tanggal;
    detail.waktu_proses = dateTime.waktu;
    detail.tunai = 0;
    detail.kembalian = 0;
    detail.status = 'batal';

   if(deleteDataPesanan(dataIndex))
    await addDataRiwayat(detail);

    await setHTMLPesananTersimpan();
    await setHTMLRiwayat();
    await sinkronisasiDataRiwayat();
    setEmptyDetailPesananTersimpan();
  }else{
    setDefaultPesanan();
  }

  $(this).attr('data-index', 0);
});

/*
|------------------------------------------------------------------------------------------------------
|                  PROSES HALAMAN RIWAYAT
|------------------------------------------------------------------------------------------------------
|
|  1. fungsi pencarian         => mencari melalui storage
|  2. fungsi setHTMLRiwayat      => menampilkan data riwayat dari storage
|                    => mengurutkan berdasarkan date terbaru secara DESC
|  3. fungsi setDetailRiwayat      => menampilkan detail pesanan dengan pesanan_tersimpan_terfokus di storage
|  4. fungsi sendEmailNota       => mengirim nota ke email melalui api backend  
|  5. fungsi printNotaRiwayat      => mencetak nota 
|  
*/

let _tgl = datetimeEvent();
let _stateRiwayat = {
  tanggal_max : _tgl.tanggal,
  waktu_max : _tgl.waktu+':59',
  nomor_urut: 0
};

$('#list-riwayat-div' ).on('scroll', function() {
  var position = $('#list-riwayat-div').scrollTop();
  var bottom = $('#list-riwayat').height() - $('#list-riwayat-div').height();
  let _outlet =  JSON.parse(localStorage.getItem('outlet_terpilih'));
  
  if( position == bottom ){
      $.ajax({
        url: urlDomain + "api/kasir/penjualan",
        type: 'get',
        headers: {
          'Accept':'application/json', 
          'Authorization':'Bearer '+getToken(),
        },
        data: {
          outlet_id: _outlet.id_outlet,
          tanggal_max: _stateRiwayat.tanggal_max,
          waktu_max: _stateRiwayat.waktu_max,
          nomor_urut: _stateRiwayat.nomor_urut,
        },
        success: function(res){
          if(res.total > 0){
            _stateRiwayat.nomor_urut += res.data.length;
            setHTMLTambahListRiwayat(res.data);
            pushDataRiwayat(res.data);
          }
        }
      });
  }
});

function pushDataRiwayat(data){
  let dataRiwayat =  JSON.parse(localStorage.getItem('riwayat'));
  for(let i = 0; i < data.length; i++){
    dataRiwayat.push(data[i]);
  }
   localStorage.setItem('riwayat', JSON.stringify(dataRiwayat));  
}

$('#pencarianRiwayat').keyup(function(){
  let text = $(this).val();
  let list = [];
  if(text !== '' && text !== null && text.length >= 1 ){
    list = _statePage.riwayat.filter(item => (
          ((item.kode_pemesanan.toString()).toLowerCase()).indexOf(text) > -1
    ) || ( 
          ((item.no_pemesanan.toString()).toLowerCase()).indexOf(text) > -1
        )
    );
    setHTMLRiwayat(list);
  }else if(text === '' || text === null || text.length < 1){
    setHTMLRiwayat(_statePage.riwayat);
  }
});
function setHTMLRiwayat(dataRiwayat = null){
  if(dataRiwayat === null)
  dataRiwayat = JSON.parse(localStorage.getItem('riwayat'));

  let tanggalArr = [];
  $.each( dataRiwayat, function( key, value ) {
    let jumlahSama = 0;
    $.each( tanggalArr, function( keyTanggal, v ) {
      if(v === value.tanggal_proses){
        jumlahSama = jumlahSama + 1;
      }
    });
    if(jumlahSama === 0)
      tanggalArr.push(value.tanggal_proses);
  });
    

  let htmlList = "";
  $.each( tanggalArr, function( keyTanggal, v ) {
    htmlList = htmlList + '<li class="list-group-item px-3 py-2 tgl-list-riwayat" data-index="'+convertTanggalListOrder(v)+'" style="background: rgba(0, 142, 255, 0.26) !important">'+convertTanggalListOrder(v)+'</li>';
    $.each( dataRiwayat, function( key, p ) {
      if(p.tanggal_proses === v )
        htmlList = htmlList + 
      '<li class="list-group-item pl-0 pr-3 pt-3 pb-2 opsi-list-riwayat" data-tanggal="'+convertTanggalListOrder(v)+'"  data-index="'+p.kode_pemesanan+'">'+
        '<div class="d-flex">'+
          '<div class="flex-fill text-left" style="width: 14%">'+
            '<div>'+
              ( p.status !== null && p.status !== undefined && p.status === 'Batal' ? 
              '<p class="h4 my-2 text-center status-batal"><i class="fas fa-receipt"></i></p>':
              '<p class="h4 my-2 text-center status-sukses "><i class="fas fa-receipt"></i></p>'
              )+
            '</div>'+
          '</div>'+
          '<div class="flex-fill text-left" style="width: 43%">'+
            '<div>'+
              '<p class="font-weight-bold mb-2">Rp '+ addCommas(p.total)+'</p>'+
            '</div>'+
            '<div>'+
              '<p class="mb-0 font-small ">'+(p.status ? p.status : 'Selesai') +' </p>'+
            '</div>'+
          '</div>'+
          '<div class="flex-fill text-right" style="width: 43%">'+
            '<div>'+
              '<p class="font-weight-bold mb-2">'+(p.waktu_proses !== null && p.waktu_proses !== undefined ? p.waktu_proses.slice(0, 5) : '')+'</p>'+
            '</div>'+
         
            '<div>'+
              '<p class="mb-0 font-small">#'+p.kode_pemesanan+'</p>'+
            '</div>'+
          '</div>'+
        '</div>'+
      '</li>';
    });
  });
  
  $('#list-riwayat').html(htmlList);
}
async function setHTMLTambahListRiwayat(dataRiwayat){
  let tanggalArr = [];
  await $.each( dataRiwayat, async function( key, value ) {
    let jumlahSama = 0;
    $.each( tanggalArr,  function( keyTanggal, v ) {
      if(v === value.tanggal_proses){
        jumlahSama = jumlahSama + 1;
      }
    });
    if(jumlahSama === 0)
      tanggalArr.push(value.tanggal_proses);
  });

  let indexRiwayatDipotong = [];
  await $.each( tanggalArr, async function( keyTanggal, v ) {
    if($('.tgl-list-riwayat[data-index="'+convertTanggalListOrder(v)+'"]').length >= 1 ) {   
      $.each( dataRiwayat, function( key, p ) {
        if(p.tanggal_proses === v ){
            ($('.opsi-list-riwayat[data-tanggal="'+convertTanggalListOrder(v)+'"]').last()).after('<li class="list-group-item pl-0 pr-3 pt-3 pb-2 opsi-list-riwayat" data-tanggal="'+convertTanggalListOrder(v)+'" data-index="'+p.kode_pemesanan+'">'+
              '<div class="d-flex">'+
                '<div class="flex-fill text-left" style="width: 14%">'+
                  '<div>'+
                    ( p.status !== null && p.status !== undefined && p.status === 'Batal' ? 
                    '<p class="h4 my-2 text-center status-batal"><i class="fas fa-receipt"></i></p>':
                    '<p class="h4 my-2 text-center status-sukses "><i class="fas fa-receipt"></i></p>'
                    )+
                  '</div>'+
                '</div>'+
                '<div class="flex-fill text-left" style="width: 43%">'+
                  '<div>'+
                    '<p class="font-weight-bold mb-2">Rp '+ addCommas(p.total)+'</p>'+
                  '</div>'+
                  '<div>'+
                    '<p class="mb-0 font-small ">'+(p.status ? p.status : 'Selesai') +' </p>'+
                  '</div>'+
                '</div>'+
                '<div class="flex-fill text-right" style="width: 43%">'+
                  '<div>'+
                    '<p class="font-weight-bold mb-2">'+(p.waktu_proses !== null && p.waktu_proses !== undefined ? p.waktu_proses.slice(0, 5) : '')+'</p>'+
                  '</div>'+
               
                  '<div>'+
                    '<p class="mb-0 font-small">#'+p.id_penjualan+'</p>'+
                  '</div>'+
                '</div>'+
              '</div>'+
            '</li>');
            indexRiwayatDipotong.push(p.id_penjualan);
        }
      });
    }
  });
  await $.each( indexRiwayatDipotong, async function( key, v ) {
    let index = dataRiwayat.findIndex(d => d.id_penjualan === v);
    await dataRiwayat.splice(index,1);
  });
  tanggalArr = await [];
  await $.each( dataRiwayat, function( key, value ) {
    let jumlahSama = 0;
    $.each( tanggalArr, function( keyTanggal, v ) {
      if(v === value.tanggal_proses){
        jumlahSama = jumlahSama + 1;
      }
    });
    if(jumlahSama === 0)
       tanggalArr.push(value.tanggal_proses);
  });

  let htmlList = await "";
  await $.each( tanggalArr, function( keyTanggal, v ) {
    htmlList = htmlList + '<li class="list-group-item px-3 py-2 tgl-list-riwayat" data-index="'+convertTanggalListOrder(v)+'" style="background: rgba(0, 142, 255, 0.26) !important">'+convertTanggalListOrder(v)+'</li>';
    $.each( dataRiwayat, function( key, p ) {
      if(p.tanggal_proses === v )
        htmlList = htmlList + 
      '<li class="list-group-item pl-0 pr-3 pt-3 pb-2 opsi-list-riwayat" data-tanggal="'+convertTanggalListOrder(v)+'"  data-index="'+p.kode_pemesanan+'">'+
        '<div class="d-flex">'+
          '<div class="flex-fill text-left" style="width: 14%">'+
            '<div>'+
              ( p.status !== null && p.status !== undefined && p.status === 'Batal' ? 
              '<p class="h4 my-2 text-center status-batal"><i class="fas fa-receipt"></i></p>':
              '<p class="h4 my-2 text-center status-sukses "><i class="fas fa-receipt"></i></p>'
              )+
            '</div>'+
          '</div>'+
          '<div class="flex-fill text-left" style="width: 43%">'+
            '<div>'+
              '<p class="font-weight-bold mb-2">Rp '+ addCommas(p.total)+'</p>'+
            '</div>'+
            '<div>'+
              '<p class="mb-0 font-small ">'+(p.status ? p.status : 'Selesai') +' </p>'+
            '</div>'+
          '</div>'+
          '<div class="flex-fill text-right" style="width: 43%">'+
            '<div>'+
              '<p class="font-weight-bold mb-2">'+(p.waktu_simpan !== null && p.waktu_simpan !== undefined ? p.waktu_simpan.slice(0, 5) : '')+'</p>'+
            '</div>'+
         
            '<div>'+
              '<p class="mb-0 font-small">#'+p.id_penjualan+'</p>'+
            '</div>'+
          '</div>'+
        '</div>'+
      '</li>';
    });
  });
  
  await $('#list-riwayat').append(htmlList);
}

function setDetailRiwayat(data){
 let htmlMenu = "";
 $.each( data.item , function( key, value ) {
   htmlMenu = htmlMenu + '<li class="list-group-item px-3 py-2 ">'+
   '<div class="d-flex">'+
   '<div class="pl-1 pr-3" style="width: auto;height:auto">'+
            '<div class="card border-0 inisial-riwayat" data-index="'+key+'" style="display:none;">'+
              '<div  class="bd-placeholder-img card-img-top bg-grey-low rounded" style="height:66px;width:70px">'+
                '<h5>'+getInitials(value.nama_menu)+'</h5>'+
              '</div>'+
            '</div>' +
            '<img data-index="'+key+'" src="'+(value.gambar ? value.gambar : '')+'" style="height:66px;width:70px" class="rounded-lg gambar-riwayat"  onerror="gambarOnErrorRiwayat(this)" />' +
          '</div>'+
   '<div class="pr-1 flex-grow-1 text-left" style="width: 30%">'+
   '<div class="text-truncate">'+
   '<p class="mb-0 font-weight-bold">'+ value.nama_menu +'</p>'+
   (jQuery.type( value.nama_variasi_menu ) === "string" ? '<p class="mb-0"><small>'+value.nama_variasi_menu+'</small></p>':'')+
              (jQuery.type( value.nama_tipe_penjualan ) === "string" ? '<p class="mb-0"><small>'+value.nama_tipe_penjualan.toUpperCase()+'</small></p>':'')+
              (jQuery.type( value.catatan ) === "string" && value.catatan !== null && value.catatan !== undefined ? '<p class="mb-0"><small>'+value.catatan+'</small></p>':'')+
   '</div>'+
   '</div>'+
   '<div class="px-1 text-center" style="width: 20%">'+ addCommas(value.harga) +'&nbsp;X&nbsp;'+ addCommas(value.jumlah) +'</div>'+
   '<div class="text-right" style="width: 50%">'+
    addCommas(value.total) +
   '</div>'+
   '</div>'+
   '</li>';
 });

  let htmlDetailRiwayat = 
    '<div class="py-3 px-4" style="border-bottom: 1px solid #eee; background: #f4f4f4;">'+
      '<div class="d-flex">'+
        '<div class="flex-fill text-left" style="width: 50%">'+
          '<p class="font-weight-bold h5 mb-1">#'+ data.no_pemesanan +'</p>'+
          '<p class="mb-1">'+ data.tanggal_simpan + ',' + data.waktu_simpan.slice(0, 5)+'</p>'+
          '<p class="mb-1">Invoice : '+data.kode_pemesanan+'</p>'+
          '<p class="mb-1">Kasir : '+ data.nama_user +'</p>'+
        '</div>'+
        '<div class="flex-fill text-right" style="width: 50%">'+
          '<p class="font-weight-bold h5 mb-1">'+(data.nama_pelanggan !== null && data.nama_pelanggan !== undefined ? data.nama_pelanggan : '') +'</p>'+
          '<p class="mb-1">'+ (data.email_pelanggan !== null && data.email_pelanggan !== undefined ? data.email_pelanggan : '') +'</p>'+
          '<p class="mb-1">'+ (data.no_hp_pelanggan !== null && data.no_hp_pelanggan !== undefined ? data.no_hp_pelanggan : '') +'</p>'+
        '</div>'+
      '</div>'+
      '<div class="pt-3">'+
        '<button class="btn btn-outline-secondary text-dark bg-white mr-3 printNotaRiwayat"  data-index="'+data.kode_pemesanan+'" style="border-color:#c4c4c4;padding:8px 25px !important;">Print Struk</button>'+
        // '<button class="btn btn-outline-secondary text-dark bg-white emailNotaRiwayat" style="border-color:#c4c4c4;padding:12px 40px !important;">Email Struk</button>'+
      '</div>'+
    '</div>'+
    '<div style="background: transparent; width: 100%; " class="p-0 hide-scroll ">'+
      '<ul class="list-group list-group-flush">'+htmlMenu +'</ul>'+
      '<div class="col-8 ml-auto my-2">'+
        '<ul class="list-group list-group-flush">'+
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 30%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0 font-weight-bold">Subtotal</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%">'+
                addCommas(data.subtotal)+
              '</div>'+
            '</div>'+
          '</li>'+
          ( data.diskon_id !== 0 ?
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0">'+(data.nama_diskon !== null ? data.nama_diskon : 'Diskon')+' '+(data.tipe_diskon === 'persen' ? '('+data.jumlah_diskon+')':'' )+'</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%"> '+
                addCommas(data.total_diskon)+
              '</div>'+
            '</div>'+
          '</li>':'')+
          ( data.pajak_id !== 0 ? 
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0">'+(data.nama_pajak !== null ? data.nama_pajak : 'Pajak')+' ('+data.jumlah_pajak+'%)</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%">'+
                addCommas(data.total_pajak)+
              '</div>'+
            '</div>'+
          '</li>':'')+
          ( data.biaya_tambahan_id !== 0 ? 
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0">'+(data.nama_biaya_tambahan !== null ? data.nama_biaya_tambahan :'Biaya Tambahan')+' ('+ data.jumlah_biaya_tambahan+'%)</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%">'+
                addCommas(data.total_biaya_tambahan)+
              '</div>'+
            '</div>'+
          '</li>':'')+
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate font-weight-bold">'+
                  '<p class="h3 mb-0">Total</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-truncate font-weight-bold">'+
                '<p class="h3 mb-0">Rp '+addCommas(data.total)+'</p>'+
              '</div>'+
            '</div>'+
          '</li>'+
          ( data.status === 'Sukses' ? 
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0">Tunai</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%">Rp '+
                addCommas(data.tunai)+
              '</div>'+
            '</div>'+
          '</li>':'')+
          ( data.status === 'Sukses' ? 
          '<li class="list-group-item px-3 py-2">'+
            '<div class="d-flex">'+
              '<div class="pr-1 flex-fill text-left" style="width: 50%">'+
                '<div class="text-truncate">'+
                  '<p class="mb-0">Kembalian</p>'+
                '</div>'+
              '</div>'+
              '<div class="text-right" style="width: 50%">Rp '+
                addCommas(data.kembalian)+
              '</div>'+
            '</div>'+
          '</li>':'')+
        '</ul>'+
      '</div>'+
    '</div>';
  $('#title-page-riwayat').html('#'+data.no_pemesanan);
  $('#detail-page-riwayat').html(htmlDetailRiwayat);
}

$('body').on('click','.opsi-list-riwayat', function(){
 var dataIndex = $(this).attr('data-index');
 var dataRiwayat = JSON.parse(localStorage.getItem('riwayat'));

 var data = dataRiwayat.find( p => p.kode_pemesanan === dataIndex);

 setDetailRiwayat(data);  
});

$('body').on('click','.printNotaRiwayat', function(){
  let _index = $(this).attr('data-index');
  let _dataRiwayats = JSON.parse(localStorage.getItem('riwayat'));
  let _riwayat = _dataRiwayats.find(v => v.kode_pemesanan === _index);

  let _outlet = JSON.parse(localStorage.getItem('outlet_terpilih'));
  let _user = JSON.parse(localStorage.getItem('user'));

  let _dataRiwayat = [];
  for(let i = 0; i < _riwayat.item.length; i++){
    let jumlahSama = 0;
    for(let a = 0; a < _dataRiwayat.length; a++){
      if(_dataRiwayat[a].nama_tipe_penjualan === _riwayat.item[i].nama_tipe_penjualan){
        jumlahSama++;
      }
    }
    if(jumlahSama === 0){
      _dataRiwayat.push({'nama_tipe_penjualan': _riwayat.item[i].nama_tipe_penjualan, 'menu':[] });
    }

    for(let a = 0; a < _dataRiwayat.length; a++){
      if(_dataRiwayat[a].nama_tipe_penjualan === _riwayat.item[i].nama_tipe_penjualan){
        _dataRiwayat[a].menu.push(
          {
              "harga": (_riwayat.item[i].harga ? 'Rp '+addCommas(_riwayat.item[i].harga) : ""), 
              "jumlah": (_riwayat.item[i].jumlah ? _riwayat.item[i].jumlah : ""), 
              "nama_variasi_menu": (_riwayat.item[i].nama_variasi_menu ? _riwayat.item[i].nama_variasi_menu : ""), 
              "nama_tipe_penjualan": ( _riwayat.item[i].nama_tipe_penjualan ? _riwayat.item[i].nama_tipe_penjualan : ""), 
              "nama_menu": ( _riwayat.item[i].nama_menu ? _riwayat.item[i].nama_menu : ""), 
              "total": (_riwayat.item[i].total ? 'Rp'+addCommas(_riwayat.item[i].total) : "")
          }
        );
      }
    }
  }
  var dataRiwayat = {
    "url_logo": _outlet.url_logo, 
    "nama_outlet": (_outlet.nama_outlet ? _outlet.nama_outlet : ""), 
    "alamat": (_outlet.alamat ? _outlet.alamat : "") , 
    "telpon": (_outlet.telpon ? _outlet.telpon : ""), 
    "nama_user": _user.nama ? _user.nama : "", 
    "nama_pelayan": "", 
    "kode_pemesanan": (_riwayat.kode_pemesanan ? _riwayat.kode_pemesanan : ""), 
    "no_pemesanan": ( _riwayat.no_pemesanan ? _riwayat.no_pemesanan : ""), 
    "waktu_proses": ( _riwayat.waktu_proses ? _riwayat.waktu_proses : ""), 
    "tanggal_proses": ( _riwayat.tanggal_proses ? _riwayat.tanggal_proses : ""),

    "pesanan": _dataRiwayat, 
    "subtotal": "Rp "+addCommas(_riwayat.subtotal), 
    //diskon
    "nama_diskon": (_riwayat.nama_diskon ? _riwayat.nama_diskon : ""), 
    "jumlah_diskon": (_riwayat.jumlah_diskon ? _riwayat.jumlah_diskon+"%":""),
    "total_diskon": (_riwayat.total_diskon ? "Rp "+addCommas(_riwayat.total_diskon) : "Rp 0"), 
    
    //biaya tambahan
    "nama_biaya_tambahan": (_riwayat.nama_biaya_tambahan ? _riwayat.nama_biaya_tambahan : ""), 
    "jumlah_biaya_tambahan": ( _riwayat.jumlah_biaya_tambahan ? _riwayat.jumlah_biaya_tambahan + '%' : ""), 
    "total_biaya_tambahan": (_riwayat.total_biaya_tambahan ? "Rp "+addCommas(_riwayat.total_biaya_tambahan) : "Rp 0"),
    
    //pajak
    "nama_pajak": (_riwayat.nama_pajak ? _riwayat.nama_pajak : ""), 
    "jumlah_pajak": ( _riwayat.jumlah_pajak ? _riwayat.jumlah_pajak + '%' : ""),
    "total_pajak": ( _riwayat.total_pajak ? "Rp "+addCommas(_riwayat.total_pajak) : "Rp 0"),

    "total": ( _riwayat.total ? "Rp "+addCommas(_riwayat.total) : "Rp 0"), 
    "tunai": ( _riwayat.tunai ? "Rp "+addCommas(_riwayat.tunai): "Rp 0" ), 
    "kembalian": ( _riwayat.kembalian ? "Rp "+addCommas(_riwayat.kembalian) : "Rp 0"), 

    "catatan": (_outlet.catatan ? _outlet.catatan : "TERIMA KASIH"),
    //-----------------------
    "website": (_outlet.website ? _outlet.website : ""), 
    "facebook": (_outlet.facebook ? _outlet.facebook : ""), 
    "instagram": (_outlet.instagram ? _outlet.instagram : ""),
    "twitter": (_outlet.twitter ? _outlet.twitter : "")
  };
  let _perangkat = JSON.parse(localStorage.getItem('perangkat'));

  setTimeout(function(){ android.printPesanan(JSON.stringify(dataRiwayat), _perangkat.mac_printer_kasir ); }, 200);
});

$('body').on('click','.emailNotaRiwayat', function(){
  kirimEmailStruk(_statePembayaran);
});
function gambarOnErrorRiwayat(data){
  $('.gambar-riwayat[data-index='+data.getAttribute('data-index')+']').hide();
  setTimeout(function(){ 
    $('.inisial-riwayat[data-index='+data.getAttribute('data-index')+']').show();
  }, 50);
}
async function kirimEmailStruk(_statePembayaran){

  let _outlet = await JSON.parse(localStorage.getItem('outlet_terpilih'));
  let _user = await JSON.parse(localStorage.getItem('user'));
  let _dataPesanan = [];
  for(let i = 0; i < _statePembayaran.pesanan.length; i++){
    let jumlahSama = 0;
    for(let a = 0; a < _dataPesanan.length; a++){
      if(_dataPesanan[a].nama_tipe_penjualan === _statePembayaran.pesanan[i].nama_tipe_penjualan){
        jumlahSama++;
      }
    }
    if(jumlahSama === 0){
      _dataPesanan.push({'nama_tipe_penjualan': _statePembayaran.pesanan[i].nama_tipe_penjualan, 'menu':[] });
    }

    for(let a = 0; a < _dataPesanan.length; a++){
      if(_dataPesanan[a].nama_tipe_penjualan === _statePembayaran.pesanan[i].nama_tipe_penjualan){
        _dataPesanan[a].menu.push(
          {
              "harga": ( _statePembayaran.pesanan[i].harga ? 'Rp '+addCommas(_statePembayaran.pesanan[i].harga) : ""), 
              "jumlah": ( _statePembayaran.pesanan[i].jumlah ? _statePembayaran.pesanan[i].jumlah : ""), 
              "nama_variasi_menu": ( _statePembayaran.pesanan[i].nama_variasi_menu ? _statePembayaran.pesanan[i].nama_variasi_menu : ""), 
              "nama_tipe_penjualan": ( _statePembayaran.pesanan[i].nama_tipe_penjualan ? _statePembayaran.pesanan[i].nama_tipe_penjualan : "" ), 
              "nama_menu": ( _statePembayaran.pesanan[i].nama_menu ? _statePembayaran.pesanan[i].nama_menu : ""), 
              "total": ( _statePembayaran.pesanan[i].total ? 'Rp '+addCommas(_statePembayaran.pesanan[i].total) : "")
          }
        );
      }
    }
  }
  let alamat = (_outlet.alamat ? _outlet.alamat : "-") + ', ' + (_outlet.kota ? _outlet.kota : "-") + ', ' + (_outlet.provinsi ? _outlet.provinsi : "-") + ', ' + (_outlet.kode_pos ? _outlet.kode_pos : "-");
  var dataPesanan = await {
    "url_logo": _outlet.url_logo, 
    "nama_outlet": _outlet.nama_outlet, 
    "alamat": alamat , 
    "telpon": (_outlet.telpon ? _outlet.telpon : ""), 
    "nama_user": (_user.nama ? _user.nama : ""), 
    "nama_pelayan": "", 
    "email_pelanggan":$('#inputKirimEmailStukTransaksi').val(),
    "kode_pemesanan": (_statePembayaran.kode_pemesanan ? _statePembayaran.kode_pemesanan : ""), 
    "no_pemesanan": ( _statePembayaran.no_pemesanan ? _statePembayaran.no_pemesanan : ""), 
    "waktu_proses": ( _statePembayaran.waktu_proses ? _statePembayaran.waktu_proses : ""), 
    "tanggal_proses": ( _statePembayaran.tanggal_proses ? _statePembayaran.tanggal_proses : ""),

    "pesanan": _dataPesanan, 
    "subtotal": (_statePembayaran.subtotal ? "Rp "+addCommas(_statePembayaran.subtotal) :"Rp 0"), 
    //diskon
    "nama_diskon": (_statePembayaran.nama_diskon ? _statePembayaran.nama_diskon : ""), 
    "jumlah_diskon": (_statePembayaran.jumlah_diskon ? _statePembayaran.jumlah_diskon+"%":""),
    "total_diskon": ( _statePembayaran.total_diskon ? "Rp "+addCommas(_statePembayaran.total_diskon) : "Rp 0"), 
    
    //biaya tambahan
    "nama_biaya_tambahan": (_statePembayaran.nama_biaya_tambahan ? _statePembayaran.nama_biaya_tambahan : ""), 
    "jumlah_biaya_tambahan": ( _statePembayaran.jumlah_biaya_tambahan ? _statePembayaran.jumlah_biaya_tambahan + '%' : ""), 
    "total_biaya_tambahan": (_statePembayaran.total_biaya_tambahan ?  "Rp "+addCommas(_statePembayaran.total_biaya_tambahan) : "Rp 0"),
    
    //pajak
    "nama_pajak": (_statePembayaran.nama_pajak ? _statePembayaran.nama_pajak : ""), 
    "jumlah_pajak": (_statePembayaran.jumlah_pajak ? _statePembayaran.jumlah_pajak + '%' : "-"),
    "total_pajak": (_statePembayaran.total_pajak ? "Rp "+addCommas(_statePembayaran.total_pajak):"Rp 0"),

    "total": ( _statePembayaran.total ? "Rp "+addCommas(_statePembayaran.total) :"Rp 0"), 
    "tunai": (_statePembayaran.tunai ? "Rp "+addCommas(_statePembayaran.tunai):"Rp 0"), 
    "kembalian": (_statePembayaran.kembalian ? "Rp "+addCommas(_statePembayaran.kembalian) : "Rp 0"), 

    "catatan": (_outlet.catatan ? _outlet.catatan : "TERIMA KASIH"),
    //-----------------------
    "website": (_outlet.website ? _outlet.website : ""), 
    "facebook": (_outlet.facebook ? _outlet.facebook : ""), 
    "instagram": (_outlet.instagram ? _outlet.instagram : ""),
    "twitter": (_outlet.twitter ? _outlet.twitter : "")
  };

  $.ajax({
    url: urlDomain + 'api/kasir/email-nota',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: {
      pesanan: dataPesanan,
      email: $('#inputKirimEmailStukTransaksi').val()
    },
    success: function(res){
      android.CustomToast('Email telah dikirim');
    },
    error: function(res){
      android.CustomSnackbar('Email gagal dikirim','red');
    }
 });
  setTimeout(function(){ resetHTMLModalSelesaiPembayaran(); }, 100);
  

}
function IsEmail(email) {
  var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  if(!regex.test(email)) {
    return false;
  }else{
    return true;
  }
}
/*
|----------------------------------------------------------------------------------------
|                               PROSES HALAMAN PENGATURAN
|----------------------------------------------------------------------------------------
|   berikut metode halaman pengaturan
|   1. setDefaulHalamanPengaturan()  =>  fungsi ini untuk memanggil function set halaman printer
|   2. setHTMLHalamanPengaturan() => fungsi ini berisi seleksi untuk mengatur function sesuai sub menu yang dilemparkan
|   
*/

var _statePengaturan = {
  daftar_printer_terdeteksi: [],
  printer_terpilih: {},
  data_from: '',
  is_empty: 1,
};

/////////////////////// SUB MENU PENGATURAN PROFIL/////////////////////////////
$('#formUpdateProfil').submit( async function(e){
  e.preventDefault(); // avoid to execute the actual submit of the form.
  var form = $(this);
  var dt = await form.serializeArray()
              .reduce(function(a, x) { a[x.name] = x.value; return a; }, {});
  if(dt['pin'].length > 4 || dt['pin'].length < 4){
    alert('Pin Maksimal 4 karakter','blue'); 
    return false;
  } 
  $.ajax({
    url: urlDomain + 'api/kasir/update-profil',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: dt,
    success: function(res){
      let userData = JSON.parse(localStorage.getItem('user'));
      userData.alamat = dt.alamat;
      userData.nama = dt.name;
      userData.pin = dt.pin;

      android.updatePIN(parseInt(dt.pin));

      localStorage.setItem('user', JSON.stringify(userData));
      setProfilInListPengaturan(userData);
      android.CustomToast('Berhasil Memperbaharui Profil');
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan koneksi','red');
    }
 });
});

$('#formUpdatePassword').submit( async function(e){
  e.preventDefault(); // avoid to execute the actual submit of the form.
  var form = $(this);
  var dt = await form.serializeArray()
              .reduce(function(a, x) { a[x.name] = x.value; return a; }, {});
   $.ajax({
    url: urlDomain + 'api/kasir/update-password',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: dt,
    success: function(res){
      android.CustomToast('Berhasil Memperbaharui Password');
    },
    error: function(res){
      if(res === 'wrong')
        android.CustomSnackbar('Password lama salah','red');
      else
        android.CustomSnackbar('Terjadi Kesalahan','red');
    }
  });
});

function setDefaultHalamanPengaturan(){
  setProfilInListPengaturan();
  setHTMLDetailHalamanPengaturan('printer');
}

async function setProfilInListPengaturan(_user = null){
  if(_user === null)
    _user = await getDataUser();

  $('#namaUserHalamanPengaturan').html(_user.nama);
  $('#emailUserHalamanPengaturan').html(_user.email);
}
$('#edinputpinupdateprofil').bind('keypress', function (e) {
    if(this.value.length>= 4) 
          {
            android.CustomSnackbar('Maksimal 4 karakter','blue'); 
            return false;
          }

    return !(e.which != 8 && e.which != 0 &&
            (e.which < 48 || e.which > 57) && e.which != 46);
});

async function setHTMLDetailHalamanPengaturan(submenu){
  if(submenu === 'profil'){
    $('.m_switch').css('visibility','hidden');
    $('#title-page-pengaturan').html('Profil');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-profil-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').hide();
    let _user = await getDataUser();

    await $('#edinputnameupdateprofil').val(_user.nama);
    await $('#edinputemailupdateprofil').val(_user.email);
    await $('#edinputpinupdateprofil').val(_user.pin);
    await $('#edinputalamatupdateprofil').val(_user.alamat);
  }
  else if(submenu === 'printer'){
    $('.m_switch').css('visibility','hidden');
    $('#title-page-pengaturan').html('Printer');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-printer-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').show();
  }
  else if(submenu === 'tentang'){
    $('.m_switch').css('visibility','hidden');
    $('#title-page-pengaturan').html('Profil');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-tentang-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').hide();
  }
  else if(submenu === 'pengaturan_lanjutan'){
    $('.m_switch').css('visibility','unset');
    $('#title-page-pengaturan').html('Pengaturan Lanjutan');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-pengaturan-lanjutan-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').hide();
    let _perangkat = getPerangkat();
    if(_perangkat.cetak_salinan_struk === 1)
      $('.jtoggler[name=cetak_salinan_struk]').attr('checked','checked');
    if(_perangkat.teruskan_ke_printer_dapur === 1)
        $('.jtoggler[name=teruskan_ke_printer_dapur]').attr('checked','checked');
  }
  else if(submenu === 'sinkronisasi'){
    $('.m_switch').css('visibility','hidden');
    $('#title-page-pengaturan').html('Sinkronisasi Data');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-sinkronisasi-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').hide();
  }
  else if(submenu === 'pengaturan_outlet'){
    $('.m_switch').css('visibility','hidden');
    $('#title-page-pengaturan').html('Pengaturan');
    $('.page-pengaturan').css('visibility','hidden');
    $('#sub-pengaturan-outlet-page-pengaturan').css('visibility','unset');
    $('#divbtntambahprinter').hide();
  }
  else if(submenu === 'syarat_penggunaan'){
    android.openURL("https://kapcake.com/syarat-ketentuan.html");
  }
  else if(submenu === 'kebijakan_privasi'){
    android.openURL("https://kapcake.com/kebijakan-privasi.html");
  }

}

//// ////////////////////////   SUBMENU PRINTER ////////////////////////
$('#modalprinterbodyinput').hide();
$('#modalprinterbodylist').show();
$('#modalprinterbuttoninput').hide();
$('#modalprinterbuttonlist').show();

$('#btnTambahPrinter').click(function (){
  $('#formModalPrinter').attr('data-method','add');
  setDefaultModalPrinter();
});
$('#btnModalPrinterKembali').click(function(){
  setDefaultModalPrinter();
});
function setDefaultModalPrinter(){
  $('#modalprinter').modal('show');
  $('#modalprinterbodylist').show();
  $('#modalprinterbuttonlist').show();
  $('#modalprinterbodyinput').hide();
  $('#modalprinterbuttoninput').hide();
  $('#btnModalPrinterKembali').hide();

  setHTMLDetailHalamanPengaturan('printer');
  setListPrinterDitemukan();
  android.cekAndRequestBluetooth();
}
// setInformasi


var _incPrinter = 0;
async function setListPrinterDitemukan(listPrinter = []){
  let htmlListPrinterDitemukan = "";
  
  let listPrinterTerfilter = [];
  for(let i = 0; i < listPrinter.length; i++){
    let deteksiPrinter = _statePengaturan.daftar_printer_terdeteksi.filter( d => d['mac'] === listPrinter[i]['mac']);
    if(deteksiPrinter.length === 0){
      await _statePengaturan.daftar_printer_terdeteksi.push(listPrinter[i]);
      await listPrinterTerfilter.push(listPrinter[i]);
    }
  }

  if(_statePengaturan.daftar_printer_terdeteksi.length > 0){
      if(_incPrinter === 0){
          $('#modalprinterbodylist').html("");
          _incPrinter = _incPrinter + 1;
      }
      
    // htmlListPrinterDitemukan = 
    // '<li class="list-group-item px-3 py-1" style="background: #f4f4f4 !important"><small>'+(listPrinter.length > 0 ? listPrinter.length : 'Tidak Ada')+' Perangkat Ditemukan</small></li>';
    $.each( listPrinterTerfilter , function( key, value ) {
      htmlListPrinterDitemukan = htmlListPrinterDitemukan + '<li class="list-group-item py-3 opsi-list-bluetooth-terdeteksi" data-nama="'+(value['nama'] ? value['nama'] : '')+'" data-mac="'+ (value['mac'] ? value['mac'] : 'Tidak Diketahui') +'"  >'+
        '<div class="d-flex">'+
          '<div class="pr-1 text-center" style="width:15%">'+
            '<div class="h4 py-2 mb-0">'+
              '<i class="fas fa-fw fa-print"></i>'+
            '</div>'+
          '</div>'+
          '<div class="pr-1 flex-grow-1 text-left">'+
            '<p class="mb-0 font-weight-bold">'+(value['nama'] ? value['nama'] : 'Tidak Diketahui')+'</p>'+
            '<p class="mb-0"><small>'+(value['mac'] ? value['mac'] : 'Tidak Diketahui')+'</small></p>'+
          '</div>'+
        '</div>'+
      '</li>';
      $('#modalprinterbodylist').append(htmlListPrinterDitemukan);
    });
    
  }
  else{
    htmlListPrinterDitemukan = 
    '<div class="px-5 py-5 w-100 h-100 text-center">'+
      '<img src="img/empty_printer.png" class="img-responsive" style="width: 30%;">'+
      '<p>Printer tidak tersedia</p>'+
    '</div>';
    $('#modalprinterbodylist').html(htmlListPrinterDitemukan);
  }
}


$('body').on('click','.opsi-list-bluetooth-terdeteksi', async function(){
  var dataMac = await $(this).attr('data-mac');
  await $('.opsi-list-bluetooth-terdeteksi').removeClass('active');
  await $(this).addClass('active');
  _statePengaturan.printer_terpilih = _statePengaturan.daftar_printer_terdeteksi.find(d => d['mac'] === dataMac);
  // $(this).html(JSON.stringify(_statePengaturan.printer_terpilih));
});


  $('#btnModalPilihPrinterInputManual').click(function(){
    $('#edMacModalPrinter').removeAttr('readonly');
    setHTMLTambahPrinter('manual');
  });

  $('#btnModalPilihPrinterSambungkan').click(function(){
    if(_statePengaturan.printer_terpilih.mac !== undefined){
      $('#edMacModalPrinter').attr('readonly','true');
      _statePengaturan.data_from = 'pencarian';
      setHTMLTambahPrinter('sambungkan');
      // android.connectingToBluetooth(_statePengaturan.printer_terpilih.mac);
    }else{
      android.CustomToast("Pilih printer terlebih dahulu");
    }
  });

  

  function setHTMLTambahPrinter(tipePenginputan = 'manual'){
    $('#modalprinterbodyinput').show();
    $('#modalprinterbodylist').hide();
    $('#modalprinterbuttoninput').show();
    $('#modalprinterbuttonlist').hide();
    $('#btnModalPrinterKembali').show();

    if(tipePenginputan == 'manual'){
      $('#edNamaModalPrinter').val('');
      $('#edJenisModalPrinter').val('Umum');
      $('#edLebarKertasModalPrinter').val('58');
      $('#edMacModalPrinter').val('');
      $('#btnHapusInputPrinter').hide();
      $('#btnBatalInputPrinter').show();
    } else if(tipePenginputan == 'sambungkan'){
      $('#btnHapusInputPrinter').hide();
      $('#btnBatalInputPrinter').show();
      $('#edJenisModalPrinter').val('Umum');
      $('#edLebarKertasModalPrinter').val('58');
      $('#edNamaModalPrinter').val(_statePengaturan.printer_terpilih.nama);
      $('#edMacModalPrinter').val(_statePengaturan.printer_terpilih.mac);
    }else{
      $('#btnBatalInputPrinter').hide();
      $('#btnHapusInputPrinter').show();
    }
  }

$('#formModalPrinter').submit( async function(e){
  e.preventDefault(); // avoid to execute the actual submit of the form.
  var form = $(this);
  var dt = await form.serializeArray()
              .reduce(function(a, x) { a[x.name] = x.value; return a; }, {});
  let _perangkat = await JSON.parse(localStorage.getItem('perangkat'));
  let _outlet = await JSON.parse(localStorage.getItem('outlet_terpilih'));
  var _data = {};
  let printer = await JSON.parse(localStorage.getItem('printer'));
  let filterPrinter = await printer.filter(v => v.mac === dt['mac']);

    if( form.attr('data-method') === 'add' && filterPrinter.length === 0){
      _data = {
        perangkat_id : _perangkat.id_perangkat,
        outlet_id: _outlet.id_outlet,
        nama_printer : dt['nama_printer'],
        jenis_printer : dt['jenis_printer'],
        lebar_kertas : dt['lebar_kertas'],
        mac : dt['mac'],
        is_uploaded : 0,
        is_hapus : 0,
      };
      await printer.push(_data);
    }else if(form.attr('data-method') === 'update'){
      let _index = printer.findIndex(v => v.mac === _statePengaturan.printer_terpilih.mac );

      printer[_index].nama_printer = dt['nama_printer'];
      printer[_index].jenis_printer = dt['jenis_printer'];
      printer[_index].lebar_kertas = dt['lebar_kertas'];
      printer[_index].mac = dt['mac'];
      printer[_index].is_uploaded = 0;
      printer[_index].is_hapus = 0;
    }else if(filterPrinter.length > 0){
      android.CustomToast('Data yang diinput tidak boleh sama');
    }

  await localStorage.setItem('printer', JSON.stringify(printer));
  $('#modalprinter').modal('hide');

  await setHTMLListPrinterSubPage(printer);
  await sinkronisasiDataPrinter();
  
});
$('body').on('click','#btnBatalInputPrinter', async function(){
  $('#modalprinter').modal('hide');
});

 function setHTMLListPrinterSubPage(printer = null){
  if(printer === null)
    printer = JSON.parse(localStorage.getItem('printer'));

  $('#jumlahPrinterTerkoneksiSubPrinterPagePengaturan').html(printer.length > 0 ? (printer.length+' Printer Terkoneksi') : 'Tidak Ada Printer Terkoneksi');

  let htmlList = "";
  $.each( printer, function( key, value ) {
    if(value.is_hapus === undefined || value.is_hapus === 0)
    htmlList = htmlList + '<li class="list-group-item p-0 list-printer" data-index="'+ value.mac +'">'+
      '<div class="d-flex">'+
        '<div class="px-1 text-center py-3 pl-3" style="width:15%">'+
          '<div class="h4 py-2 mb-0 icon-list-printer"  data-index="'+ value.mac +'">'+
            '<i class="fas fa-fw fa-print"></i>'+
          '</div>'+
        '</div>'+
        '<div class="pr-1 flex-grow-1 text-left py-3">'+
          '<p class="mb-0 font-weight-bold">'+ value.nama_printer +'</p>'+
          '<p class="mb-0"><small>'+value.jenis_printer+'</small></p>'+
        '</div>'+
        '<div class="text-right py-3 pr-5 area-btn-printer" style="width: 40%">'+
          '<div class="btn btn-outline-secondary mr-3 btn-printer test-print" data-index="'+ value.mac +'"> <i class="fa fa-print" aria-hidden="true"></i> </div>'+
          '<div class="btn btn-outline-info btn-printer edit-list-printer" style="padding:7px 25px !important" data-index="'+ value.mac +'"> Detail </div>'+
        '</div>'+
      '</div>'+
    '</li>';
  });
  $('#listPrinterSubPrinterPagePengaturan').html(htmlList);
}
// stop-koneksi-bluetooth
// list-printer
function findListPrinter(mac){
  let printer = JSON.parse(localStorage.getItem('printer'));
  _statePengaturan.printer_terpilih = printer.find(d => d.mac === mac);
  return _statePengaturan.printer_terpilih;
}

//./
$('body').on('click','.list-printer', async function (e) {
    e.stopPropagation();
    let _index = $(this).attr('data-index');
    await $('.icon-list-printer').html('<i class="fas fa-fw fa-print "></i>');
    $('.icon-list-printer[data-index="'+_index+'"]').html('<i class="fas fa-fw fa-check-circle text-success"></i>');
    // _statePengaturan.data_from = 'storage';
    
    /// simpan di storage
    let _perangkat = await JSON.parse(localStorage.getItem('perangkat'));
    _perangkat.mac_printer_kasir = _index;
    await localStorage.setItem('perangkat', JSON.stringify(_perangkat));

    android.connectingToBluetooth(_index);



    // $(this).css('visibility','hidden');
});


$('body').on('click', '.edit-list-printer', async function(){
  let thisMac = await $(this).attr('data-index');
  let _data = await findListPrinter(thisMac);
  await $('#modalprinter').modal('show');

  setHTMLTambahPrinter('list');
  $('#edNamaModalPrinter').val(_data.nama_printer);
  $('#edJenisModalPrinter').val(_data.jenis_printer);
  $('#edLebarKertasModalPrinter').val(_data.lebar_kertas);
  $('#edMacModalPrinter').attr('readonly','true');
  $('#edMacModalPrinter').val(_data.mac);
  $('#formModalPrinter').attr('data-method','update');
});

$('body').on('click','.area-btn-printer', function (e) {
  e.stopPropagation();  
});


$('body').on('click','.test-print', async function(e){
  e.stopPropagation();
  let _index = await $(this).attr('data-index');
  let _perangkat = await JSON.parse(localStorage.getItem('perangkat'));
  if(_index !== _perangkat.mac_printer_kasir){
    android.CustomToast('Silahkan koneksikan printer terlebih dahulu');
    return false;
  }
  let _data = await findListPrinter($(this).attr('data-index'));
  tesPrint(_data.mac);
});
$('body').on('click','.stop-koneksi-bluetooth', function(e){
  e.stopPropagation();
  let _mac = $(this).attr('data-index');
  _statePengaturan.data_from = 'storage';
  _statePengaturan.printer_terpilih = findListPrinter(_mac);
  // let _data = findListPrinter($(this).attr('data-index'));
  android.CustomSnackbar($(this).attr('data-index'),'blue');
  // $(this).css('visibility','hidden');
  // $('.koneksikan-list-printer[data-index="'+_mac+'"]').css('visibility','unset');
  android.stopConnected(_mac);
    // android.connectingToBluetooth(_mac);
  // stopKoneksiBluetooth(mac);
});

$('body').on('click','#btnHapusInputPrinter', function(){
  $('#modalprinter').modal('hide');
  $('#modalkonfirmasihapusprinter').modal('show');
});

$('body').on('click','#btnModalHapusPrinter', async function(){
  let printer = await JSON.parse(localStorage.getItem('printer'));
  let index = await printer.findIndex(v => v.mac === _statePengaturan.printer_terpilih.mac && (v.is_hapus === undefined || v.is_hapus === 0));
  printer[index].is_hapus = 1;
  printer[index].is_uploaded = 0;
  await localStorage.setItem('printer', JSON.stringify(printer));
  $('#modalkonfirmasihapusprinter').modal('hide');
  await setHTMLListPrinterSubPage();
  sinkronisasiDataPrinter();
  stopKoneksiBluetooth(_statePengaturan.printer_terpilih.mac);
});
async function tesPrint(mac){
  let outletTerpilih = await JSON.parse(localStorage.getItem('outlet_terpilih'));
  await android.tesPrint(  
    (outletTerpilih.nama_outlet !== null ? outletTerpilih.nama_outlet:'-') , 
    (outletTerpilih.telpon !== null ? outletTerpilih.telpon:'-'),
    (outletTerpilih.alamat !== null ? outletTerpilih.alamat:'-'),
    'Bluetooth', 
    mac,
    outletTerpilih.url_logo
  );
}

function stopKoneksiBluetooth(mac){
  android.stopConnected(mac);
}


async function konfirmasiBluetoothTerhubung(){
  // android.CustomSnackbar('Terpanggil ji konfirmasi', 'red');
  if( _statePengaturan.data_from === 'storage' ){
    // await $('.koneksikan-list-printer[data-index="'+ _statePengaturan.printer_terpilih.mac +'"]').hide();
    // await $('.stop-koneksi-bluetooth[data-index="'+ _statePengaturan.printer_terpilih.mac +'"]').show();
    
    await $('.koneksikan-list-printer[data-index="'+ _statePengaturan.printer_terpilih.mac +'"]').css('visibility','hidden');
    await $('.stop-koneksi-bluetooth[data-index="'+_statePengaturan.printer_terpilih.mac+'"]').css('visibility','unset');

    let _printer = await JSON.parse(localStorage.getItem('printer'));
    let _index = await _printer.findIndex(v => v.mac === _statePengaturan.printer_terpilih.mac);
    _printer[_index].is_connected = 1;
    await localStorage.setItem('printer', JSON.stringify(_printer));

  }else if(_statePengaturan.data_from === 'pencarian'){
    setHTMLTambahPrinter('sambungkan');
  }
}

async function konfirmasiBluetoothTerputus(){
  await $('.koneksikan-list-printer[data-index="'+ _statePengaturan.printer_terpilih.mac +'"]').css('visibility','unset');
  await $('.stop-koneksi-bluetooth[data-index="'+_statePengaturan.printer_terpilih.mac+'"]').css('visibility','hidden');
  // android.CustomSnackbar('yang baca ini jomblo', 'red');
}

/////////////////////// SUB MENU PENGATURAN PENGATURAN LANJUTAN /////////////////////////////
$(document).on('jt:toggled', function(event, target) {
  let perangkat = JSON.parse(localStorage.getItem('perangkat'));
  if($(target).prop('name') === 'cetak_salinan_struk'){
    if($(target).prop('checked') === true){
      perangkat.cetak_salinan_struk = 1;
    }else{
      perangkat.cetak_salinan_struk = 0;
    }
  }else if($(target).prop('name') === 'teruskan_ke_printer_dapur'){
    if($(target).prop('checked') === true){
      perangkat.teruskan_ke_printer_dapur = 1;
    }else{
      perangkat.teruskan_ke_printer_dapur = 0;
    }
  }
  localStorage.setItem('perangkat', JSON.stringify(perangkat)); 
});



//// ////////////////////////   SUBMENU SINKRONISAIS ////////////////////////
$('body').on('click','.list-sinkronisasi', async function(){
  let _opsi = $(this).data('index');

  if(_opsi === 'produk'){
    sinkronisasiDataMenu();
  }else if(_opsi === 'pesanan_tersimpan'){
    sinkronisasiDataPesanan();
  }else if(_opsi === 'riwayat'){
    sinkronisasiDataRiwayat();
  }else if(_opsi === 'pelanggan'){
    sinkronisasiDataPelanggan();
  }else if(_opsi === 'outlet'){
    await $(".btn-sinkronisasi[data-index='outlet']").addClass('fa-spin');
    await sinkronisasiDataPesanan(true);
    await sinkronisasiDataRiwayat();
    await sinkronisasiDataPrinter();
    await sinkronisasiDataPelanggan();
    await sinkronisasiDataMenu();

    await sinkronisasiDataMeja();
    await sinkronisasiDataJenisPemesanan();
    await sinkronisasiDataDiskon();
    await sinkronisasiDataBiayaTambahan();


    await setTimeout(function(){ 
      $(".btn-sinkronisasi[data-index='outlet']").removeClass('fa-spin');
    }, 5000);
  }
});

// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

/*
|--------------------------------------------------------------------------
|                STORAGE PESANAN
|--------------------------------------------------------------------------
|  * storage pesanan menyimpan data yang telah diputuskan statusnya antara batal atau dibayar
|  * berikut daftar fungsi untuk mengelola data pesanan
|  1. getAllpesanan(kondisi status = false, ) => untuk mengambil seluruh pesanan dengan kondisi status jika ingin menggunakan seleksi dengan return data
|  2. getDetailpesanan(kode_pemesanan) => untuk mengambil detail pesanan , perlu mengirimkan parameter kode_pemesanan sebagai index dengan return data
|  3. addDatapesanan(data) => untuk menambah daftar pesanan diperlukan parameter data berupa format pesanan terfokus dengan return tru
|  4. updateDatapesanan(data,index) => untuk memperbaharui data pesanan, perlu mengirimkan data dan index yg berupa kode pemesanan dengan return tru
|  5. deleteDatapesanan(index) => untuk menghapus data pesanan, perlu mengirimkan index yg berupa kode pemesanan dengan return true
*/

function getAllPesanan(status = false){
 return JSON.parse(localStorage.getItem('pesanan'));
}

function getDetailPesanan(index){
 let pesanan = JSON.parse(localStorage.getItem('pesanan'));
 return pesanan.find(p=> p.kode_pemesanan === index);
}

async function addDataPesanan(data){
 let pesanan = await JSON.parse(localStorage.getItem('pesanan'));
 await pesanan.push(data);
 await localStorage.setItem('pesanan', JSON.stringify(pesanan));
 return true;
}

async function updateDataPesanan(data, index){
 let pesanan = await JSON.parse(localStorage.getItem('pesanan'));
 let pesananIndex = await pesanan.findIndex( p => p.kode_pemesanan === index);
 pesanan[pesananIndex] = data;
 await localStorage.setItem('pesanan', JSON.stringify(pesanan));
 return true;
}
async function deleteDataPesanan(index){
 var pesanan = await JSON.parse(localStorage.getItem('pesanan'));
 var pesananIndex = await pesanan.findIndex( p => p.kode_pemesanan === index);

 await pesanan.splice(pesananIndex,1);
 await localStorage.setItem('pesanan', JSON.stringify(pesanan));

 return true;
}



/*
|--------------------------------------------------------------------------
|                STORAGE RIWAYAT
|--------------------------------------------------------------------------
|  * storage riwayat menyimpan data yang telah diputuskan statusnya antara batal atau dibayar
|  * berikut daftar fungsi untuk mengelola data riwayat
|  1. getAllRiwayat(kondisi status = false, ) => untuk mengambil seluruh riwayat dengan kondisi status jika ingin menggunakan seleksi dengan return data
|  2. getDetailRiwayat(kode_pemesanan) => untuk mengambil detail riwayat , perlu mengirimkan parameter kode_pemesanan sebagai index dengan return data
|  3. addDataRiwayat(data) => untuk menambah daftar riwayat diperlukan parameter data berupa format pesanan terfokus dengan return tru
|  4. updateDataRiwayat(data,index) => untuk memperbaharui data riwayat, perlu mengirimkan data dan index yg berupa kode pemesanan dengan return tru
*/

function getAllRiwayat(status = false){
 if(status !== false){
   let riwayat = JSON.parse(localStorage.getItem('riwayat'));
   return riwayat.filter(p=> p.status === status);
 }else{
   return JSON.parse(localStorage.getItem('riwayat'));
 }
}

function getDetailRiwayat(index){
 let riwayat = JSON.parse(localStorage.getItem('riwayat'));
 return riwayat.find(p=> p.kode_pemesanan === index);
}

async function addDataRiwayat(data){
 let riwayat = await JSON.parse(localStorage.getItem('riwayat'));
 await riwayat.unshift(data);
 await localStorage.setItem('riwayat', JSON.stringify(riwayat));
 return true;
}

async function updateDataRiwayat(data, index){
 let riwayat = await JSON.parse(localStorage.getItem('riwayat'));
 let riwayatIndex = await riwayat.findIndex( p => p.kode_pemesanan === index);
 riwayat[riwayatIndex] = data;
 await localStorage.setItem('riwayat', JSON.stringify(riwayat));
 return true;
}

/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA MENU
|--------------------------------------------------------------------------
|
*/

function sinkronisasiDataMenu(){   
  $(".btn-sinkronisasi[data-index='produk']").addClass('fa-spin');
  let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/menu',
    headers: {
      'Accept':'application/json',
      'Authorization':'Bearer '+getToken(),
    },
    method: 'GET',
    dataType: 'json',
    data: {
      outlet_id : data.id_outlet,
    },
    success: function(data){
      localStorage.setItem('menu', JSON.stringify(data.menu));
      localStorage.setItem('kategori_menu', JSON.stringify(data.kategori_menu));
      setHTMLMenu(data.menu, true);
      setHTMLKategoriMenu(data.kategori_menu);
      $(".btn-sinkronisasi[data-index='produk']").removeClass('fa-spin');

      let tglSinkronisasi = datetimeEvent();
      
      $('#teksSinkronisasiDataProduk').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
      $(".btn-sinkronisasi[data-index='produk']").removeClass('fa-spin');
    }
  });
}



/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA PELANGGAN
|--------------------------------------------------------------------------
|
*/

async function sinkronisasiDataPelanggan(){
  $(".btn-sinkronisasi[data-index='pelanggan']").addClass('fa-spin');
  let dataPelanggan = await JSON.parse(localStorage.getItem('pelanggan'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/pelanggan',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: {
      pelanggan : dataPelanggan
    },
    success: function(res){
      localStorage.setItem('pelanggan', JSON.stringify(res));
      setHTMLPelanggan(res);
      $(".btn-sinkronisasi[data-index='pelanggan']").removeClass('fa-spin');

      let tglSinkronisasi = datetimeEvent();
      $('#teksSinkronisasiDataPelanggan').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
    },
    error: function(res){
      
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
      $(".btn-sinkronisasi[data-index='pelanggan']").removeClass('fa-spin');
    }
  });
}


/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA MEJA
|--------------------------------------------------------------------------
|
*/

function sinkronisasiDataMeja(){   
  let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/meja',
    headers: {
      'Accept':'application/json',
      'Authorization':'Bearer '+getToken(),
    },
    method: 'GET',
    dataType: 'json',
    data: {
      outlet_id : data.id_outlet,
    },
    success: function(data){
      localStorage.setItem('meja', JSON.stringify(data.meja));
      localStorage.setItem('kategori_meja', JSON.stringify(data.kategori_meja));

      setHTMLKategoriMeja();
      if(data.kategori_meja && data.kategori_meja.length > 0){
        _state.kategoriMejaTerpilih = data.kategori_meja[0].id_kategori_meja;
        pencarianMeja();
      }


      let tglSinkronisasi = datetimeEvent();
      $('#teksSinkronisasiDataOutlet').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
    
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}

/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA DISKON
|--------------------------------------------------------------------------
|
*/

function sinkronisasiDataDiskon(){   
  let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/diskon',
    headers: {
      'Accept':'application/json',
      'Authorization':'Bearer '+getToken(),
    },
    method: 'GET',
    dataType: 'json',
    data: {
      outlet_id : data.id_outlet,
    },
    success: function(data){
      localStorage.setItem('diskon', JSON.stringify(data));
      setHTMLDiskon(data);
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}

/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA BIAYA TAMBAHAN
|--------------------------------------------------------------------------
|
*/

function sinkronisasiDataBiayaTambahan(){   
  let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/biaya-tambahan',
    headers: {
      'Accept':'application/json',
      'Authorization':'Bearer '+getToken(),
    },
    method: 'GET',
    dataType: 'json',
    data: {
      outlet_id : data.id_outlet,
    },
    success: function(data){
      localStorage.setItem('biaya_tambahan', JSON.stringify(data));
      setHTMLBiayaTambahan(data);
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}

/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA BIAYA TAMBAHAN
|--------------------------------------------------------------------------
|
*/

function sinkronisasiDataJenisPemesanan(){   
  let data = JSON.parse(localStorage.getItem('outlet_terpilih'));
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/jenis-pemesanan',
    headers: {
      'Accept':'application/json',
      'Authorization':'Bearer '+getToken(),
    },
    method: 'GET',
    dataType: 'json',
    data: {
      outlet_id : data.id_outlet,
    },
    success: function(data){
      localStorage.setItem('jenis_pemesanan', JSON.stringify(data));
    },
    error: function(res){
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}

/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA PESANAN
|--------------------------------------------------------------------------
|
*/
function setDataPemesananStorageFormat(data){  
 let dataFormat = [];

 $.each( data, function( key, value ) {
   let detail = value;
   detail.pesanan = [];
   $.each( detail.item, function( k, v ) {
     // if( (detail.pesanan.filter( p => p.id_tipe_penjualan === v.tipe_penjualan_id )).length <= 0){
     //   detail.pesanan.push({ id_tipe_penjualan: v.tipe_penjualan_id, nama_tipe_penjualan: v.nama_tipe_penjualan });
     // }
     delete(v.bisnis_id);
     delete(v.created_at);
     delete(v.id_pemesanan_item);
     delete(v.kategori_menu_id);
     delete(v.nama_kategori_menu);
     delete(v.outlet_id);
     delete(v.pemesanan_id);
     delete(v.updated_at);
     delete(v.user_id);

     // let pesananIndex = detail.pesanan.findIndex( p => p.id_tipe_penjualan === v.tipe_penjualan_id);
     // detail.pesanan[pesananIndex].menu = [];
     detail.pesanan.push(v);
   });
    delete(detail.created_at);
    delete(detail.updated_at);
    delete(detail.item);
    detail.is_uploaded = 1;
    dataFormat.push(detail);
  });

 return dataFormat;
}
/// post data pemesanan
async function setDataPemesananAPIFormat(){
  let dataFormat = await JSON.parse(localStorage.getItem('pesanan'));
  let dataSetReturn = [];
  if(dataFormat.length > 0)
    for (var i = 0; i < dataFormat.length; i++) {
      if(dataFormat[i]['is_uploaded'] === 0){
        delete(dataFormat[i]['is_uploaded']);
        if(dataFormat[i]['tanggal_proses'] === ""){ // diberikan filter agar tidak terupload
          dataFormat[i]['tanggal_proses'] = null;
          dataFormat[i]['waktu_proses'] = null;
        }
        dataSetReturn.push(dataFormat[i]);
      }
    }
  return dataSetReturn;
}

async function sinkronisasiDataPesanan(syncRiwayat = false){
  $(".btn-sinkronisasi[data-index='pesanan_tersimpan']").addClass('fa-spin');
  let data = await JSON.parse(localStorage.getItem('outlet_terpilih'));
  let dataPemesanan = await setDataPemesananAPIFormat();
  $.ajax({
    async:true,
    url: urlDomain + 'api/kasir/pemesanan',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: {
      outlet_id : data.id_outlet,
      pemesanan : dataPemesanan
    },
    success: function(res){
      let datas = setDataPemesananStorageFormat(res);
      localStorage.setItem('pesanan', JSON.stringify(datas));
      setHTMLPesananTersimpan(datas);
      $(".btn-sinkronisasi[data-index='pesanan_tersimpan']").removeClass('fa-spin');
      if(syncRiwayat === true) sinkronisasiDataRiwayat();


      let tgl = datetimeEvent();
      $('#teksSinkronisasiDataPesananTersimpan').html('Terakhir disinkronkan '+tgl.tanggal+' '+tgl.waktu);
      
    },
    error: function(res){
      $(".btn-sinkronisasi[data-index='pesanan_tersimpan']").removeClass('fa-spin');
      
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
 });
}


/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA RIWAYAT
|--------------------------------------------------------------------------
|
*/

async function setDataRiwayatAPIFormat(){
  let dataFormat = await JSON.parse(localStorage.getItem('riwayat'));
  let dataSetReturn = [];
  for (var i = 0; i < dataFormat.length; i++) {
    if(dataFormat[i]['is_uploaded'] === 0){

      delete(dataFormat[i]['is_uploaded']);

      dataFormat[i]['item'] = [];
      $.each( dataFormat[i]['pesanan'], function( k, v ) {
        dataFormat[i]['item'].push(v);
      });

      delete(dataFormat[i]['pesanan']);

      dataSetReturn.push(dataFormat[i]);
    }
  }
 return dataSetReturn;
}

async function sinkronisasiDataRiwayat(){
  $(".btn-sinkronisasi[data-index='riwayat']").addClass('fa-spin');
 let data = await JSON.parse(localStorage.getItem('outlet_terpilih'));
 let dataRiwayat = await setDataRiwayatAPIFormat();
 $.ajax({
   url: urlDomain + 'api/kasir/penjualan',
   headers: {
     'Accept':'application/json', 
     'Authorization':'Bearer '+getToken(),
   },
   method: 'POST',
   data: {
      outlet_id : data.id_outlet,
      penjualan : dataRiwayat
   },
   success: function(res){
      if(res.length > 0){
        _stateRiwayat.tanggga_max = res[0]['tanggal_proses']; 
        _stateRiwayat.waktu_max = res[0]['waktu_proses']; 
      }
      _stateRiwayat.nomor_urut = res.length; 
      $.each( res, function( key, value ) {
        res[key].is_uploaded = 1;
      });
      localStorage.setItem('riwayat', JSON.stringify(res)); 
      setHTMLRiwayat(res);
      $(".btn-sinkronisasi[data-index='riwayat']").removeClass('fa-spin');

      let tglSinkronisasi = datetimeEvent();
      $('#teksSinkronisasiDataRiwayat').html('Terakhir disinkronkan '+tglSinkronisasi.tanggal+' '+tglSinkronisasi.waktu);
    },
    error: function(res){
      $(".btn-sinkronisasi[data-index='riwayat']").removeClass('fa-spin');
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}


/*
|--------------------------------------------------------------------------
|          SINKRONISASI DATA PRINTER
|--------------------------------------------------------------------------
|
*/

async function sinkronisasiDataPrinter(){
  $(".btn-sinkronisasi[data-index='printer']").addClass('fa-spin');
  let printer = await JSON.parse(localStorage.getItem('printer'));
  let _perangkat = await JSON.parse(localStorage.getItem('perangkat'));
  let _dataPrinter = [];
  await $.each( printer, function( key, value ) {
    if(value.is_uploaded === 0)
      _dataPrinter.push(value); 
  });
  if(_dataPrinter.length > 0)
  $.ajax({
    async: true,
    url: urlDomain + 'api/kasir/printer',
    headers: {
      'Accept':'application/json', 
      'Authorization':'Bearer '+getToken(),
    },
    method: 'POST',
    data: {
      perangkat_id: _perangkat.id_perangkat,
      printer : _dataPrinter
    },
    success: function(res){
      localStorage.setItem('printer', JSON.stringify(res)); 
      setHTMLListPrinterSubPage(res);
      $(".btn-sinkronisasi[data-index='printer']").removeClass('fa-spin');
    },
    error: function(res){
      $(".btn-sinkronisasi[data-index='printer']").removeClass('fa-spin');
      android.CustomSnackbar('Terjadi kesalahan sinkronisasi','red');
    }
  });
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
           ///////////////////     FUNGSI TAMBAHAN    ////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function datetimeEvent(){
 var d = new Date();
 return {
   'tanggal_angka' : (d.getFullYear()).toString().substr(2, 2) + "" + zeroFill(d.getMonth()+1,2) + "" + zeroFill(d.getDate(),2),
   'tanggal' : d.getFullYear() + "-" + zeroFill(d.getMonth()+1,2) + "-" + zeroFill(d.getDate(),2),
   'tanggal_kemarin' : d.getFullYear() + "-" + zeroFill(d.getMonth()+1,2) + "-" + zeroFill(d.getDate()-1,2),
   'waktu' : zeroFill(d.getHours(), 2) + ":" + zeroFill(d.getMinutes(), 2)
 }
}

function addCommas(nStr)
{
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + '.' + '$2');
  }
  return x1 + x2;
}

function zeroFill (str, max = 4) {
  str = str.toString();
  return str.length < max ? zeroFill("0" + str, max) : str;
}

var getInitials = function (string) {
  var names = string.split(' '),
  initials = names[0].substring(0, 1).toUpperCase();
  if (names.length > 1) {
    initials += names[names.length - 1].substring(0, 1).toUpperCase();
  }
  if(initials.length === 1){
    return string.substr(0, 2).toUpperCase().toLowerCase().replace(/\b[a-z]/g, function(letter) {
      return letter.toUpperCase();
    });
  }else{
    return initials.toLowerCase().replace(/\b[a-z]/g, function(letter) {
      return letter.toUpperCase();
    });
  }
};
function convertTanggalListOrder(tgl){
    let tanggal = datetimeEvent();
    if ( tgl === tanggal.tanggal){
      return 'Hari ini';
    }else if(tgl === tanggal.tanggal_kemarin){
      return 'Kemarin';
    }else{
      return tgl;
    }
  }

  function ucfirst(str){
          str = str.toLowerCase();
          return str.replace(/(\b)([a-zA-Z])/,
                   function(firstLetter){
                      return   firstLetter.toUpperCase();
                   });
     }
Sentry.init({ dsn: 'https://e363dec19daa410ea6a2f168871a3cc3@sentry.io/1722700' });

</script>
</body>
</html>